# ==================== Promtail 配置 ====================
# 日志采集器配置

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: game-server

scrape_configs:
  # ==================== 游戏服务日志 ====================
  - job_name: game-services
    static_configs:
      - targets:
          - localhost
        labels:
          job: game-server
          __path__: /var/log/game/**/*.log
    
    pipeline_stages:
      # 解析 JSON 格式日志 (SLS 格式)
      - match:
          selector: '{job="game-server"} |~ "^\\{"'
          stages:
            - json:
                expressions:
                  time: time
                  level: level
                  service: service
                  server: server
                  thread: thread
                  logger: logger
                  msg: msg
                  exception: exception
            - labels:
                level:
                service:
                server:
            - timestamp:
                source: time
                format: "2006-01-02 15:04:05.000"
      
      # 解析普通文本日志
      - match:
          selector: '{job="game-server"} !~ "^\\{"'
          stages:
            - regex:
                expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}) \[(?P<thread>[^\]]+)\] (?P<level>\w+)\s+(?P<logger>[^ ]+) - (?P<message>.*)$'
            - labels:
                level:
            - timestamp:
                source: timestamp
                format: "2006-01-02 15:04:05.000"

  # ==================== Docker 容器日志 ====================
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.+)'
        target_label: container
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service
    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
      - output:
          source: output
