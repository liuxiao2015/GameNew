# 分布式微服务游戏服务器架构设计文档

> **版本**: v4.0  
> **更新日期**: 2026-01  
> **设计目标**: 开发效率、性能、扩展性并存  
> **核心特性**: Actor 无锁化模型 + 生产级框架能力  
> **适用团队**: 2-3人小团队

---

## v4.0 更新内容

### 新增框架能力

| 分类 | 组件 | 说明 |
|------|------|------|
| **协议处理** | ProtocolDispatcher | 统一协议分发，自动参数注入，异常处理 |
| **链路追踪** | TraceContext | 全链路 traceId 传递，日志自动携带 |
| **参数校验** | Validator | 便捷参数校验，抛出 BizException |
| **安全防护** | SecurityFilter | IP黑名单、XSS过滤、敏感词过滤 |
| **请求验证** | RequestValidator | 时间戳+签名验证，防重放攻击 |
| **性能监控** | ServerMonitor | CPU、内存、在线人数、请求统计 |
| **健康检查** | HealthController | K8s 存活/就绪探针端点 |
| **告警通知** | AlertService | 异常/性能/业务告警 |
| **超时控制** | TimeoutInterceptor | 操作超时保护 |
| **优雅停机** | GracefulShutdown | 有序关闭，数据安全保存 |
| **敏感数据** | SensitiveDataMasker | 日志脱敏处理 |

### 架构变更

1. **握手协议由网关独占处理**: 避免协议路由冲突
2. **统一协议号管理**: 使用 `MethodId` 常量类替代硬编码
3. **统一 Proto 文件**: 合并为单一 `game.proto` 文件
4. **异步执行优化**: 修复 TraceContext 双重清理问题
5. **错误处理优化**: Handler 抛出 BizException，框架统一转换

### 相关文档

- [框架能力总览](../FRAMEWORK_CAPABILITIES.md) - 所有底层能力详解
- [协议常量参考](../PROTOCOL_REFERENCE.md) - 协议号定义
- [登录流程](../LOGIN_FLOW.md) - 完整登录流程说明

---

## 目录

1. [项目概述](#1-项目概述)
2. [技术选型](#2-技术选型)
3. [整体架构](#3-整体架构)
4. [Actor 无锁化模型](#4-actor-无锁化模型)
5. [模块设计](#5-模块设计)
6. [数据层设计](#6-数据层设计)
7. [网关层设计](#7-网关层设计)
8. [业务服务设计](#8-业务服务设计)
9. [定时任务系统](#9-定时任务系统)
10. [运营后台系统](#10-运营后台系统)
11. [日志系统](#11-日志系统)
12. [监控方案](#12-监控方案)
13. [部署架构](#13-部署架构)
14. [扩展性设计](#14-扩展性设计)

---

## 1. 项目概述

### 1.1 设计目标

| 目标 | 说明 |
|------|------|
| **开发效率** | 使用成熟框架，减少样板代码，快速开发业务 |
| **高性能** | Actor 无锁化设计，10万+ QPS，毫秒级响应 |
| **可扩展** | 微服务架构，水平扩展，支持百万在线 |
| **易维护** | 模块清晰，2-3人可维护 |
| **稳定可靠** | 无单点故障，数据安全，优雅启停 |

### 1.2 设计原则

```
1. 业务层无锁化
   - 采用 Actor 模型，每个实体一个 Actor
   - Actor 内部单线程处理，天然无锁
   - 开发者只需关注业务逻辑，无需考虑并发问题

2. 数据分层
   - L1: Actor 内存 (ns级) - 在线玩家热数据
   - L2: Redis 缓存 (μs级) - 温数据、共享数据
   - L3: MongoDB 持久 (ms级) - 冷数据、持久化

3. 简化运维
   - 只使用 Redis + MongoDB，不引入 MySQL
   - 使用阿里云托管服务进行监控
   - 日志打印到文件，由 SLS Agent 采集

4. 渐进式扩展
   - 单实例可支撑 2-5万在线
   - 横向扩展可达百万在线
   - 一致性哈希保证玩家会话粘性
```

### 1.3 适用场景

- MMORPG、SLG、卡牌、休闲等各类游戏
- 需要高并发、低延迟的实时游戏服务
- 小团队快速开发、迭代

---

## 2. 技术选型

### 2.1 技术栈总览

| 层级 | 组件 | 版本 | 用途 | 选型理由 |
|------|------|------|------|---------|
| **语言** | Java | 21 LTS | 编程语言 | 虚拟线程、Record、模式匹配 |
| **框架** | Spring Boot | 3.3.5 | 应用框架 | 生态成熟、开发效率高 |
| **网络** | Netty | 4.1.108 | 网关通信 | 高性能、零拷贝、连接复用 |
| **RPC** | Dubbo | 3.2.9 | 服务通信 | 高性能、一致性哈希、服务治理 |
| **注册中心** | Nacos | 2.3.0 | 服务治理 | 注册发现 + 配置中心 |
| **数据库** | MongoDB | 7.0+ | 主存储 | 灵活文档结构、适合游戏数据 |
| **缓存** | Redis | 7.0+ | 热数据/队列 | 高性能、数据结构丰富 |
| **本地缓存** | Caffeine | 3.1.8 | Actor 缓存 | 高性能、自动过期 |
| **定时任务** | XXL-Job | 2.4+ | 任务调度 | 分布式调度、可视化管理 |
| **序列化** | Protobuf | 3.25+ | 客户端通信协议 | 高性能、跨语言、强类型 |
| **JSON** | Jackson | 2.15+ | 内部通信/调试 | 可读性好 |
| **日志** | Logback | 1.4+ | 日志框架 | 输出 *.sls.log 供采集 |
| **监控** | 阿里云 ARMS | - | APM | 性能监控、告警 |
| **日志采集** | 阿里云 SLS | - | 日志服务 | 日志采集、分析 |

### 2.2 为什么选择 Redis + MongoDB

| 存储 | 用途 | 优势 |
|------|------|------|
| **Redis** | 在线玩家数据缓存、排行榜、消息队列、分布式锁 | 极高性能、丰富数据结构 |
| **MongoDB** | 玩家数据持久化、公会数据、操作日志、聊天记录 | 灵活Schema、适合游戏数据 |

**不使用 MySQL 的理由**：
- 游戏数据结构复杂多变，关系型数据库维护成本高
- 游戏业务很少需要复杂 SQL 查询和强事务
- MongoDB 的文档模型更适合存储背包、装备等嵌套数据
- 减少运维复杂度，专注一种存储

### 2.3 为什么选择 Actor 模型

| 对比项 | 传统方案 (锁) | Actor 方案 (无锁) |
|--------|-------------|------------------|
| 并发模型 | 共享状态 + 锁 | 消息传递 + 单线程 |
| 开发复杂度 | 高 (需考虑死锁、竞态) | 低 (顺序思维) |
| 性能 | 锁竞争开销 | 无锁，极致性能 |
| 可维护性 | 难 (并发 Bug 难排查) | 易 (确定性执行) |
| 扩展性 | 差 | 好 (Actor 可分布) |

---

## 3. 整体架构

### 3.1 架构全景图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                 │
│              Unity / Unreal / H5 / 小程序 / APP                 │
└───────────────────────────┬─────────────────────────────────────┘
                            │ TCP / WebSocket
┌───────────────────────────▼─────────────────────────────────────┐
│                       网关层 (Gateway)                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Netty Server (TCP/WebSocket)                            │   │
│  │  - 协议解析 (Protobuf/JSON)                              │   │
│  │  - 连接管理 (Session)                                     │   │
│  │  - 权限验证 (Token)                                       │   │
│  │  - 流量控制 (限流/熔断)                                   │   │
│  │  - 路由转发 (一致性哈希)                                  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                  Nginx (负载均衡，可选)                          │
└───────────────────────────┬─────────────────────────────────────┘
                            │ Dubbo3 RPC (Triple 协议)
┌───────────────────────────▼─────────────────────────────────────┐
│                 服务网格层 (Service Mesh)                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Nacos (服务注册发现 + 配置中心)                         │   │
│  │  - 服务自动注册                                           │   │
│  │  - 健康检查                                               │   │
│  │  - 配置热更新                                             │   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                    业务服务层 (Actor 无锁化)                      │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Game Service (核心游戏服务)                              │    │
│  │ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │
│  │ │Player   │ │Player   │ │Player   │ │Player   │ ...   │    │
│  │ │Actor    │ │Actor    │ │Actor    │ │Actor    │       │    │
│  │ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │
│  │ 每个玩家一个 Actor，单线程处理，无锁                     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Guild Service (公会服务)                                 │    │
│  │ ┌─────────┐ ┌─────────┐ ┌─────────┐                    │    │
│  │ │Guild    │ │Guild    │ │Guild    │ ...                │    │
│  │ │Actor    │ │Actor    │ │Actor    │                    │    │
│  │ └─────────┘ └─────────┘ └─────────┘                    │    │
│  │ 每个公会一个 Actor，成员操作串行执行，无锁               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐  │
│  │Login       │ │Chat        │ │Match       │ │Rank        │  │
│  │Service     │ │Service     │ │Service     │ │Service     │  │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                       支撑服务层                                  │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐                  │
│  │Task        │ │GM          │ │Log         │                  │
│  │Service     │ │Service     │ │Service     │                  │
│  │(定时任务)   │ │(运营后台)   │ │(日志处理)   │                  │
│  └────────────┘ └────────────┘ └────────────┘                  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────▼───────┐   ┌───────▼───────┐   ┌───────▼───────┐
│    Redis      │   │   MongoDB     │   │    Nacos      │
│   (热数据)    │   │   (持久化)    │   │  (注册/配置)   │
│               │   │               │   │               │
│ - Actor 缓存  │   │ - 玩家数据    │   │ - 服务注册    │
│ - 排行榜      │   │ - 公会数据    │   │ - 配置中心    │
│ - 消息队列    │   │ - 操作日志    │   │               │
│ - 分布式锁    │   │ - 聊天记录    │   │               │
└───────────────┘   └───────────────┘   └───────────────┘
```

### 3.2 请求处理流程

```
1. 客户端发送请求
      ↓
2. Gateway 接收并解析协议
      ↓
3. Token 验证 → 限流检查
      ↓
4. 一致性哈希路由 (按 roleId) → 选择 Game Service 实例
      ↓
5. Dubbo RPC 调用 Game Service
      ↓
6. ActorSystem 获取 PlayerActor (缓存/加载)
      ↓
7. 消息投递到 Actor 邮箱
      ↓
8. Actor 单线程处理业务逻辑 (无锁)
      ↓
9. 返回结果，Actor 标记脏数据
      ↓
10. 定时批量持久化到 Redis/MongoDB
```

### 3.3 数据分层策略

| 层级 | 存储 | 延迟 | 用途 | 容量规划 |
|------|------|------|------|---------|
| **L1** | Actor 内存 | ns 级 | 在线玩家完整数据 | 10万玩家 ≈ 10GB |
| **L2** | Redis | μs 级 | 玩家缓存、排行榜、队列 | 100万玩家 ≈ 50GB |
| **L3** | MongoDB | ms 级 | 所有持久化数据 | 无限制 |

**数据流转**：
- 玩家上线：MongoDB → Redis → Actor 内存
- 玩家操作：Actor 内存 (实时) → 脏标记
- 定时保存：Actor 内存 → Redis + MongoDB (10秒)
- 玩家下线：Actor 内存 → MongoDB → 释放 Actor

---

## 4. Actor 无锁化模型

### 4.1 核心设计思想

```
传统方式 (有锁):
  玩家A ──┐
          ├──→ [锁] ──→ 共享数据 ──→ 解锁
  玩家B ──┘

Actor 方式 (无锁):
  玩家A ──→ [消息队列] ──→ [Actor 单线程处理] ──→ 私有数据
```

**Actor 的三大特性**：
1. **状态私有**：每个 Actor 拥有自己的数据，外部不可直接访问
2. **消息驱动**：Actor 之间通过消息通信，异步非阻塞
3. **单线程处理**：Actor 内部消息顺序处理，天然无锁

### 4.2 Actor 类型设计

| Actor 类型 | 实体 | 职责 | 生命周期 |
|-----------|------|------|---------|
| **PlayerActor** | 玩家 | 玩家所有数据和操作 | 上线创建，30分钟无操作销毁 |
| **GuildActor** | 公会 | 公会数据和成员操作 | 按需创建，10分钟无操作销毁 |
| **TeamActor** | 组队 | 组队数据和操作 | 创建组队时创建，解散时销毁 |
| **BattleActor** | 战场/副本 | 战斗实例管理 | 开始时创建，结束时销毁 |
| **AuctionActor** | 拍卖行 | 竞价操作 | 常驻 |

### 4.3 PlayerActor 设计

**数据结构**：
```
PlayerActor
├── roleId          # 角色ID
├── PlayerData      # 玩家完整数据
│   ├── 基础信息 (等级、经验、金币)
│   ├── 背包数据 (物品列表)
│   ├── 装备数据 (装备槽位)
│   ├── 任务数据 (进行中/已完成)
│   └── 属性数据 (战斗属性)
├── mailbox         # 消息邮箱 (阻塞队列)
├── dirty           # 脏标记
└── executor        # 虚拟线程执行器
```

**消息类型**：
| 消息类型 | 说明 |
|---------|------|
| addExp | 增加经验 |
| addGold | 增加金币 |
| addItem | 添加物品 |
| removeItem | 移除物品 |
| equipItem | 装备物品 |
| unequipItem | 卸下装备 |
| acceptQuest | 接受任务 |
| completeQuest | 完成任务 |
| joinGuild | 加入公会 |
| leaveGuild | 退出公会 |

### 4.4 GuildActor 设计 (集体数据无锁化)

**设计要点**：
- 每个公会一个 GuildActor
- 所有公会操作 (加入、退出、捐献、升级) 在 Actor 内串行执行
- 玩家操作公会时，发送消息到 GuildActor
- 跨 Actor 通信通过消息传递

**数据结构**：
```
GuildActor
├── guildId         # 公会ID
├── GuildData       # 公会完整数据
│   ├── 基础信息 (名称、等级、公告)
│   ├── 成员列表 (Map<roleId, Member>)
│   ├── 公会资金/经验
│   └── 公会技能
├── mailbox         # 消息邮箱
└── dirty           # 脏标记
```

**消息类型**：
| 消息类型 | 说明 |
|---------|------|
| joinGuild | 成员加入 |
| leaveGuild | 成员退出 |
| donate | 成员捐献 |
| promoteMember | 提升职位 |
| kickMember | 踢出成员 |
| upgradeLevel | 公会升级 |
| updateNotice | 修改公告 |

### 4.5 跨 Actor 通信

**场景**：玩家加入公会
```
1. PlayerActor 发起请求
      ↓
2. 通过 ActorSystem 找到 GuildActor
      ↓
3. 向 GuildActor 发送 joinGuild 消息
      ↓
4. GuildActor 处理加入逻辑，返回结果
      ↓
5. 成功后，向 PlayerActor 发送 setGuildId 消息
      ↓
6. PlayerActor 更新玩家公会信息
```

### 4.6 ActorSystem 管理

**功能**：
- 管理所有 Actor 的生命周期
- 使用 Caffeine Cache 实现 Actor 缓存
- 自动加载 (从 Redis/MongoDB)
- 自动过期 (保存数据后释放)
- 提供 Actor 查找和消息发送接口

**缓存配置**：
| Actor 类型 | 最大数量 | 过期时间 | 说明 |
|-----------|---------|---------|------|
| PlayerActor | 100,000 | 30分钟 | 在线玩家 |
| GuildActor | 10,000 | 10分钟 | 活跃公会 |
| TeamActor | 50,000 | 5分钟 | 活跃队伍 |
| BattleActor | 10,000 | 5分钟 | 进行中战斗 |

---

## 5. 模块设计

### 5.1 项目结构

```
game-server-framework/
├── pom.xml                          # 父 POM
│
├── framework/                       # 框架层
│   ├── framework-common/            # 公共组件
│   ├── framework-core/              # 核心框架
│   ├── framework-actor/             # Actor 框架
│   ├── framework-data/              # 数据访问
│   └── framework-log/               # 日志组件
│
├── gateway/                         # 网关服务
│   └── gateway-server/
│
├── services/                        # 业务服务
│   ├── service-api/                 # 服务接口
│   ├── service-game/                # 游戏服务
│   ├── service-guild/               # 公会服务
│   ├── service-login/               # 登录服务
│   ├── service-chat/                # 聊天服务
│   ├── service-rank/                # 排行服务
│   ├── service-task/                # 定时任务
│   └── service-gm/                  # 运营后台
│
└── tools/                           # 工具
    ├── code-generator/              # 代码生成器
    └── deploy/                      # 部署脚本
```

### 5.2 框架层模块

#### framework-common
| 组件 | 说明 |
|------|------|
| ErrorCode | 统一错误码枚举 |
| Result | 统一返回结果 |
| PageResult | 分页结果 |
| BaseException | 异常基类 |
| BusinessException | 业务异常 |
| IdGenerator | ID 生成器 (雪花算法) |
| JsonUtil | JSON 工具类 |
| TimeUtil | 时间工具类 |

#### framework-core
| 组件 | 说明 |
|------|------|
| NetworkServer | Netty 服务器封装 |
| ProtobufCodec | Protobuf 编解码器 |
| SessionManager | 会话管理 |
| RpcConfig | Dubbo 配置 |
| EventBus | 事件总线 |
| CacheService | 缓存服务封装 |

#### framework-actor
| 组件 | 说明 |
|------|------|
| BaseActor | Actor 基类 |
| ActorMessage | Actor 消息 |
| ActorSystem | Actor 管理器 |
| PlayerActor | 玩家 Actor |
| GuildActor | 公会 Actor |
| ActorMetrics | Actor 监控指标 |

#### framework-data
| 组件 | 说明 |
|------|------|
| RedisService | Redis 操作封装 |
| MongoRepository | MongoDB 操作封装 |
| DataLoader | 数据加载器 |
| DataSaver | 数据保存器 |

#### framework-log
| 组件 | 说明 |
|------|------|
| OperationLog | 操作日志实体 |
| OperationLogService | 异步日志服务 |
| LogType | 日志类型枚举 |

### 5.3 业务服务模块

| 服务 | 端口 | 职责 |
|------|------|------|
| gateway-server | 9001/9002 | 网关，协议转换，路由 |
| service-login | 8001 | 登录注册，Token 管理 |
| service-game | 8002 | 核心游戏逻辑 (PlayerActor) |
| service-guild | 8003 | 公会系统 (GuildActor) |
| service-chat | 8004 | 聊天系统 |
| service-rank | 8005 | 排行榜系统 |
| service-task | 8006 | 定时任务 |
| service-gm | 8080 | 运营后台 (HTTP) |

---

## 6. 数据层设计

### 6.1 Redis 数据结构

| Key 格式 | 类型 | 说明 | TTL |
|---------|------|------|-----|
| player:data:{roleId} | String (JSON) | 玩家数据缓存 | 30分钟 |
| guild:data:{guildId} | String (JSON) | 公会数据缓存 | 10分钟 |
| rank:level | Sorted Set | 等级排行榜 | 永久 |
| rank:combat | Sorted Set | 战力排行榜 | 永久 |
| online:players | Set | 在线玩家列表 | 永久 |
| token:{token} | String | Token -> roleId | 24小时 |
| rate_limit:{api}:{roleId} | String | 限流计数 | 1分钟 |
| lock:{resource} | String | 分布式锁 | 30秒 |
| stream:chat:{channel} | Stream | 聊天消息队列 | 7天 |

### 6.2 MongoDB 集合设计

| 集合名 | 说明 | 索引 |
|--------|------|------|
| player_data | 玩家数据 | roleId (unique), accountId, level |
| guild_data | 公会数据 | guildId (unique), level |
| account | 账号数据 | accountId (unique), username |
| operation_log | 操作日志 | roleId, type, createTime; TTL 90天 |
| chat_message | 聊天记录 | channel, createTime; TTL 7天 |
| mail | 邮件数据 | roleId, status, createTime; TTL 30天 |
| game_config | 游戏配置 | configName, version |

### 6.3 玩家数据结构 (MongoDB Document)

```
player_data {
  _id: ObjectId,
  roleId: Long,
  accountId: Long,
  roleName: String,
  level: Integer,
  exp: Long,
  gold: Long,
  diamond: Long,
  vipLevel: Integer,
  guildId: Long,
  
  attributes: {
    hp: Integer,
    attack: Integer,
    defense: Integer,
    speed: Integer
  },
  
  inventory: [
    { itemId: Integer, count: Integer, slot: Integer }
  ],
  
  equipment: {
    weapon: { itemId, level, attributes },
    armor: { itemId, level, attributes },
    ...
  },
  
  quests: [
    { questId, progress, status }
  ],
  
  createTime: DateTime,
  updateTime: DateTime,
  lastLoginTime: DateTime
}
```

---

## 7. 网关层设计

### 7.1 网关职责

| 功能 | 说明 |
|------|------|
| 协议解析 | 支持 TCP + Protobuf、WebSocket + Protobuf |
| 连接管理 | Session 管理、心跳检测、断线重连 |
| 权限验证 | Token 验证、白名单接口 |
| 流量控制 | 全局限流、IP 限流、用户限流 |
| 路由转发 | 一致性哈希路由到业务服务 |
| 消息推送 | 服务端主动推送到客户端 |

### 7.2 Protobuf 协议设计

#### 7.2.1 传输层协议格式

**请求协议 (客户端 → 服务端)**：
```
+----------------+----------------+----------------+----------------+------------------+
|    包总长度    |    请求序号    |    协议号      |    方法号      |  Protobuf Body   |
|    4 bytes     |    4 bytes     |    2 bytes     |    2 bytes     |     N bytes      |
+----------------+----------------+----------------+----------------+------------------+
```

**响应协议 (服务端 → 客户端)**：
```
+----------------+----------------+----------------+------------------+
|    包总长度    |    请求序号    |    错误码      |  Protobuf Body   |
|    4 bytes     |    4 bytes     |    4 bytes     |     N bytes      |
+----------------+----------------+----------------+------------------+
```

**推送协议 (服务端主动推送)**：
```
+----------------+----------------+----------------+------------------+
|    包总长度    |    推送类型    |    协议号      |  Protobuf Body   |
|    4 bytes     |    2 bytes     |    2 bytes     |     N bytes      |
+----------------+----------------+----------------+------------------+
```

#### 7.2.2 协议号规划

| 协议号范围 | 模块 | 说明 |
|-----------|------|------|
| 1000-1999 | Login | 登录相关 |
| 2000-2999 | Player | 玩家相关 |
| 3000-3999 | Inventory | 背包相关 |
| 4000-4999 | Equipment | 装备相关 |
| 5000-5999 | Quest | 任务相关 |
| 6000-6999 | Guild | 公会相关 |
| 7000-7999 | Chat | 聊天相关 |
| 8000-8999 | Rank | 排行相关 |
| 9000-9999 | System | 系统相关 |

#### 7.2.3 Proto 文件组织

```
proto/
├── common.proto          # 公共定义 (Result, ErrorCode, 基础类型)
├── login.proto           # 登录协议
├── player.proto          # 玩家协议
├── inventory.proto       # 背包协议
├── equipment.proto       # 装备协议
├── quest.proto           # 任务协议
├── guild.proto           # 公会协议
├── chat.proto            # 聊天协议
├── rank.proto            # 排行协议
└── push.proto            # 服务端推送协议
```

#### 7.2.4 Proto 定义示例

**common.proto**：
```protobuf
syntax = "proto3";
package game.proto;
option java_package = "com.game.proto";
option java_outer_classname = "CommonProto";

// 通用结果
message Result {
    int32 code = 1;          // 错误码，0表示成功
    string message = 2;      // 错误信息
}

// 物品信息
message ItemInfo {
    int32 item_id = 1;       // 物品ID
    int32 count = 2;         // 数量
}
```

**player.proto**：
```protobuf
syntax = "proto3";
package game.proto;
option java_package = "com.game.proto";
option java_outer_classname = "PlayerProto";

import "common.proto";

// 获取玩家信息请求 (协议号: 2001)
message GetPlayerInfoRequest {
    int64 role_id = 1;
}

// 获取玩家信息响应
message GetPlayerInfoResponse {
    Result result = 1;
    PlayerInfo player = 2;
}

// 玩家信息
message PlayerInfo {
    int64 role_id = 1;
    string role_name = 2;
    int32 level = 3;
    int64 exp = 4;
    int64 gold = 5;
    int64 diamond = 6;
    int32 vip_level = 7;
}
```

#### 7.2.5 协议映射配置

服务端通过配置文件映射协议号到处理方法：

| 协议号 | 请求消息 | 响应消息 | 处理服务 |
|--------|---------|---------|---------|
| 1001 | LoginRequest | LoginResponse | LoginService.login |
| 2001 | GetPlayerInfoRequest | GetPlayerInfoResponse | PlayerService.getPlayerInfo |
| 2002 | AddExpRequest | AddExpResponse | PlayerService.addExp |
| 6001 | JoinGuildRequest | JoinGuildResponse | GuildService.joinGuild |

### 7.3 路由策略

- 登录接口：随机路由到任意 Login Service
- 游戏接口：一致性哈希路由 (按 roleId)
- 公会接口：一致性哈希路由 (按 guildId)
- 聊天接口：广播/指定路由

---

## 8. 业务服务设计

### 8.1 service-login (登录服务)

**功能**：
- 账号注册 (用户名/手机/第三方)
- 账号登录 (密码验证/Token 生成)
- Token 验证
- 服务器列表
- 角色列表/创建

**数据存储**：
- MongoDB: account 集合
- Redis: token 缓存

### 8.2 service-game (游戏服务) ⭐ 核心

**功能**：
- 玩家数据管理 (PlayerActor)
- 属性计算
- 背包系统
- 装备系统
- 任务系统
- 技能系统

**Actor 模式**：
- 每个在线玩家一个 PlayerActor
- 所有操作通过消息驱动
- 定时保存脏数据

### 8.3 service-guild (公会服务) ⭐ 集体数据

**功能**：
- 公会创建/解散
- 成员加入/退出
- 成员捐献
- 公会升级
- 职位管理
- 公会战

**Actor 模式**：
- 每个公会一个 GuildActor
- 成员操作串行执行
- 跨 Actor 消息通信

### 8.4 service-chat (聊天服务)

**功能**：
- 世界聊天
- 公会聊天
- 私聊
- 系统公告

**实现**：
- Redis Stream 作为消息队列
- 消息持久化到 MongoDB (TTL 7天)

### 8.5 service-rank (排行服务)

**功能**：
- 等级排行榜
- 战力排行榜
- 公会排行榜
- 排行奖励

**实现**：
- Redis Sorted Set 存储排行
- 定时任务刷新/结算

---

## 9. 定时任务系统

### 9.1 技术选型：XXL-Job

**选择理由**：
- 分布式调度，避免重复执行
- 可视化管理界面
- 任务失败重试、报警
- 支持分片任务

### 9.2 任务列表

| 任务名称 | Cron 表达式 | 说明 |
|---------|------------|------|
| saveAllActorData | 0/10 * * * * ? | 每10秒保存脏数据 |
| refreshRankList | 0 0 0 * * ? | 每天0点刷新排行榜 |
| sendRankRewards | 0 5 0 * * ? | 每天0:05发放排行奖励 |
| cleanExpiredMails | 0 0 2 * * ? | 每天2点清理过期邮件 |
| cleanExpiredLogs | 0 0 3 * * ? | 每天3点清理过期日志 |
| settleGuildWar | 0 0 21 * * ? | 每天21点结算公会战 |
| reloadGameConfig | 0/30 * * * * ? | 每30秒检查配置变更 |
| statisticsOnline | 0 * * * * ? | 每分钟统计在线人数 |

---

## 10. 运营后台系统

### 10.1 功能模块

```
GM Admin (运营后台)
├── 玩家管理
│   ├── 玩家查询 (ID/昵称/等级)
│   ├── 玩家详情
│   ├── 修改数据 (金币/钻石/经验)
│   ├── 封禁/解封
│   └── 操作日志查询
├── 公会管理
│   ├── 公会列表
│   ├── 公会详情
│   └── 解散公会
├── 邮件系统
│   ├── 发送全服邮件
│   ├── 发送指定玩家
│   └── 批量补偿
├── 配置管理
│   ├── 配置上传
│   ├── 配置热更新
│   └── 版本回滚
├── 统计分析
│   ├── 在线统计
│   ├── 付费统计
│   └── 留存分析
└── 系统管理
    ├── GM 账号管理
    ├── 权限管理
    └── 操作审计
```

### 10.2 技术实现

- 前端：Vue3 + Element Plus
- 后端：Spring Boot + RESTful API
- 权限：Spring Security + JWT
- 审计：AOP 记录所有 GM 操作

---

## 11. 日志系统

### 11.1 日志分类

| 日志类型 | 文件名 | 说明 |
|---------|--------|------|
| 应用日志 | app.sls.log | 服务运行日志 |
| 操作日志 | operation.sls.log | 金币/物品流水 |
| 访问日志 | access.sls.log | 接口调用日志 |
| GM日志 | gm.sls.log | GM 操作审计 |
| 错误日志 | error.sls.log | 异常堆栈 |

### 11.2 日志格式

```
时间|服务名|实例IP|日志级别|TraceId|内容
2024-01-15 10:30:00|game-service|192.168.1.21|INFO|abc123|Player login: roleId=123456
```

### 11.3 操作日志内容

| 字段 | 说明 |
|------|------|
| roleId | 角色ID |
| roleName | 角色名 |
| type | 日志类型 (GOLD/ITEM/EXP...) |
| operation | 操作类型 (add/remove/use) |
| itemId | 物品ID |
| beforeCount | 变化前数量 |
| afterCount | 变化后数量 |
| reason | 变化原因 |
| createTime | 创建时间 |

### 11.4 日志采集

- 日志打印到 *.sls.log 文件
- 阿里云 Logtail Agent 自动采集
- 上传到阿里云 SLS 进行分析

---

## 12. 监控方案

### 12.1 监控架构

```
应用服务 → Micrometer 埋点 → 阿里云 ARMS
    ↓
日志文件 → Logtail Agent → 阿里云 SLS
    ↓
告警规则 → 钉钉/短信通知
```

### 12.2 监控指标

| 分类 | 指标 | 说明 |
|------|------|------|
| **业务指标** | game.online.players | 在线玩家数 |
| | game.actor.count | Actor 总数 |
| | game.actor.mailbox.size | 平均邮箱大小 |
| | game.player.login.count | 登录次数 |
| **系统指标** | jvm.memory.used | JVM 内存 |
| | jvm.gc.pause | GC 暂停时间 |
| | system.cpu.usage | CPU 使用率 |
| **RPC指标** | dubbo.provider.rt | RPC 响应时间 |
| | dubbo.provider.qps | RPC QPS |

### 12.3 告警规则

| 告警项 | 条件 | 级别 |
|--------|------|------|
| 在线人数异常 | 5分钟内下降50% | P1 |
| 接口响应慢 | RT > 500ms 持续5分钟 | P2 |
| 错误率高 | 错误率 > 1% 持续5分钟 | P2 |
| 内存不足 | JVM 内存 > 80% | P2 |
| 服务不可用 | 健康检查失败 | P0 |

---

## 13. 部署架构

### 13.1 开发环境 (Docker Compose)

| 服务 | 数量 | 配置 |
|------|------|------|
| Gateway | 1 | 2C 4G |
| Game Service | 1 | 4C 8G |
| Guild Service | 1 | 2C 4G |
| Login Service | 1 | 2C 4G |
| MongoDB | 1 | 2C 4G |
| Redis | 1 | 1C 2G |
| Nacos | 1 | 1C 2G |
| XXL-Job | 1 | 1C 2G |

### 13.2 生产环境 (小规模 1-3万在线)

| 服务 | 数量 | 配置 |
|------|------|------|
| Nginx | 2 | 4C 8G |
| Gateway | 3 | 8C 16G |
| Game Service | 3 | 16C 32G |
| Guild Service | 2 | 8C 16G |
| Login Service | 2 | 4C 8G |
| Chat Service | 2 | 4C 8G |
| MongoDB | 3 (副本集) | 8C 32G |
| Redis | 3 (哨兵) | 4C 16G |
| Nacos | 3 (集群) | 4C 8G |

### 13.3 生产环境 (大规模 10万+在线)

| 服务 | 数量 | 配置 |
|------|------|------|
| Nginx/LVS | 3+ | 8C 16G |
| Gateway | 5-10 | 16C 32G |
| Game Service | 10-50 | 32C 64G |
| Guild Service | 3-5 | 16C 32G |
| Login Service | 3 | 8C 16G |
| Chat Service | 3 | 8C 16G |
| MongoDB | 9+ (分片) | 16C 64G |
| Redis | 12+ (集群) | 8C 32G |

---

## 14. 扩展性设计

### 14.1 水平扩展策略

```
单实例 (1-2万在线)
    ↓
横向扩展 Game Service (2-10万在线)
    ↓ 一致性哈希自动分配
多机房部署 (10万+在线)
    ↓ DNS 就近接入
```

### 14.2 扩展点设计

| 扩展点 | 说明 |
|--------|------|
| 新增 Actor 类型 | 继承 BaseActor，注册到 ActorSystem |
| 新增业务服务 | 独立服务模块，Dubbo 注册 |
| 新增定时任务 | XXL-Job 后台配置 |
| 新增 GM 功能 | GM Admin 添加接口 |
| 新增监控指标 | Micrometer 埋点 |

### 14.3 版本兼容

- 协议版本号
- 数据结构兼容 (只增不删)
- 滚动更新策略

---

## 附录

### A. 错误码规划

| 范围 | 分类 |
|------|------|
| 0 | 成功 |
| 10000-10999 | 系统错误 |
| 20000-20999 | 认证错误 |
| 30000-30999 | 业务错误 - 玩家 |
| 31000-31999 | 业务错误 - 公会 |
| 32000-32999 | 业务错误 - 背包 |
| 40000-40999 | 限流错误 |

### B. 接口规范

- 服务接口定义在 service-api 模块
- 使用 Protobuf 定义 DTO
- 返回统一 Result 结构
- 异常使用错误码，不抛异常

### C. 开发规范

- Java 17 特性优先 (Record、Pattern Matching)
- 4空格缩进，120字符行长
- 构造器注入，避免字段注入
- 中文注释
- 单元测试覆盖率 >= 80%

---

**文档版本**: v4.0  
**最后更新**: 2026-01
