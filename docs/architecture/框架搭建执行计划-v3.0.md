# 游戏服务器框架搭建执行计划

> **版本**: v3.0  
> **预计周期**: 6 周  
> **团队规模**: 2-3 人  
> **目标**: 搭建完整的 Actor 无锁化游戏服务器框架

---

## 目录

1. [项目概览](#1-项目概览)
2. [里程碑规划](#2-里程碑规划)
3. [第一阶段：基础框架](#3-第一阶段基础框架-week-1)
4. [第二阶段：Actor 框架](#4-第二阶段actor-框架-week-2)
5. [第三阶段：数据层](#5-第三阶段数据层-week-3)
6. [第四阶段：网关与服务](#6-第四阶段网关与服务-week-4)
7. [第五阶段：支撑系统](#7-第五阶段支撑系统-week-5)
8. [第六阶段：集成测试](#8-第六阶段集成测试-week-6)
9. [验收标准](#9-验收标准)
10. [风险与应对](#10-风险与应对)

---

## 1. 项目概览

### 1.1 最终目录结构

```
game-server-framework/
├── pom.xml                          # 父 POM
├── framework/                       # 框架层 (5个模块)
│   ├── framework-common/            # 公共组件
│   ├── framework-core/              # 核心框架
│   ├── framework-actor/             # Actor 框架 ⭐
│   ├── framework-data/              # 数据访问
│   └── framework-log/               # 日志组件
├── gateway/                         # 网关服务
│   └── gateway-server/
├── services/                        # 业务服务
│   ├── service-api/                 # 服务接口
│   ├── service-game/                # 游戏服务 ⭐
│   ├── service-guild/               # 公会服务 ⭐
│   ├── service-login/               # 登录服务
│   ├── service-chat/                # 聊天服务
│   ├── service-rank/                # 排行服务
│   ├── service-task/                # 定时任务
│   └── service-gm/                  # 运营后台
└── tools/                           # 工具
    ├── code-generator/
    └── deploy/
```

### 1.2 技术栈确认

| 组件 | 版本 | 状态 |
|------|------|------|
| Java | 21 | ✅ 确定 |
| Spring Boot | 3.3.5 | ✅ 确定 |
| Netty | 4.1.108 | ✅ 确定 |
| Dubbo | 3.2.9 | ✅ 确定 |
| Nacos | 2.3.0 | ✅ 确定 |
| MongoDB | 7.0+ | ✅ 确定 |
| Redis | 7.0+ | ✅ 确定 |
| Caffeine | 3.1.8 | ✅ 确定 |
| XXL-Job | 2.4+ | ✅ 确定 |
| Protobuf | 3.25+ | ✅ 确定 |

### 1.3 开发环境准备

**必需环境**：
- JDK 21
- Maven 3.9+
- Docker Desktop
- IDE (IntelliJ IDEA 推荐)
- Git

**本地服务 (Docker)**：
- MongoDB 7.0
- Redis 7.0
- Nacos 2.3.0
- XXL-Job Admin

---

## 2. 里程碑规划

### 2.1 总体时间线

```
Week 1: 基础框架 (framework-common, framework-core)
    ↓
Week 2: Actor 框架 (framework-actor) ⭐ 核心
    ↓
Week 3: 数据层 (framework-data, framework-log)
    ↓
Week 4: 网关与核心服务 (gateway, service-game, service-guild)
    ↓
Week 5: 支撑系统 (service-login, service-task, service-gm)
    ↓
Week 6: 集成测试与优化
```

### 2.2 里程碑定义

| 里程碑 | 周期 | 交付物 | 验收标准 |
|--------|------|--------|---------|
| **M1** | Week 1 | 基础框架 | 单元测试通过 |
| **M2** | Week 2 | Actor 框架 | Actor 功能验证 |
| **M3** | Week 3 | 数据层 | 数据读写验证 |
| **M4** | Week 4 | 核心服务 | 端到端流程跑通 |
| **M5** | Week 5 | 支撑系统 | 全部服务可用 |
| **M6** | Week 6 | 完整框架 | 压力测试通过 |

---

## 3. 第一阶段：基础框架 (Week 1)

### 3.1 目标

- 创建项目骨架
- 完成 framework-common 模块
- 完成 framework-core 模块基础部分

### 3.2 任务清单

#### Day 1: 项目初始化

| 任务 | 说明 | 产出 |
|------|------|------|
| 创建父工程 | Maven 多模块项目 | pom.xml |
| 配置依赖管理 | 统一版本管理 | dependencyManagement |
| 创建模块骨架 | 所有模块目录结构 | 模块 pom.xml |
| 配置 Git | .gitignore, README | Git 仓库 |
| 配置代码规范 | checkstyle, editorconfig | 规范文件 |

#### Day 2-3: framework-common 模块

| 任务 | 说明 | 产出 |
|------|------|------|
| ErrorCode | 统一错误码枚举 | ErrorCode.java |
| Result | 统一返回结果 (Record) | Result.java |
| PageResult | 分页结果 | PageResult.java |
| 异常体系 | BaseException, BusinessException | 异常类 |
| IdGenerator | 雪花算法 ID 生成器 | IdGenerator.java |
| JsonUtil | JSON 工具类 (Jackson) | JsonUtil.java |
| TimeUtil | 时间工具类 | TimeUtil.java |
| 单元测试 | 所有工具类测试 | *Test.java |

#### Day 4-5: framework-core 模块 (基础)

| 任务 | 说明 | 产出 |
|------|------|------|
| EventBus | 进程内事件总线 | EventBus.java |
| Event | 事件基类 | Event.java |
| EventListener | 事件监听器接口 | EventListener.java |
| AsyncEventBus | 异步事件总线 | AsyncEventBus.java |
| 单元测试 | 事件系统测试 | EventBusTest.java |

### 3.3 验收标准

- [ ] 项目可以正常编译 (`mvn clean compile`)
- [ ] framework-common 单元测试通过
- [ ] framework-core 事件系统测试通过
- [ ] 代码规范检查通过

---

## 4. 第二阶段：Actor 框架 (Week 2) ⭐ 核心

### 4.1 目标

- 完成 framework-actor 模块
- 实现 ActorSystem 核心功能
- 实现 PlayerActor 和 GuildActor

### 4.2 任务清单

#### Day 1-2: Actor 核心

| 任务 | 说明 | 产出 |
|------|------|------|
| ActorMessage | Actor 消息定义 | ActorMessage.java |
| BaseActor | Actor 基类 | BaseActor.java |
| 消息循环 | 单线程消息处理循环 | 集成在 BaseActor |
| 邮箱实现 | BlockingQueue 邮箱 | 集成在 BaseActor |
| 虚拟线程 | Java 21 虚拟线程执行器 | 集成在 BaseActor |

**BaseActor 核心功能**：
- 消息邮箱 (BlockingQueue)
- 单线程消息循环 (虚拟线程)
- 消息处理抽象方法
- 脏标记机制
- 定时保存机制
- 生命周期管理 (start/stop)

#### Day 3: ActorSystem

| 任务 | 说明 | 产出 |
|------|------|------|
| ActorSystem | Actor 管理器 | ActorSystem.java |
| Caffeine 缓存 | Actor 缓存管理 | 集成在 ActorSystem |
| 自动加载 | 从 Redis/MongoDB 加载 | loadActor 方法 |
| 自动过期 | 过期时保存并释放 | removalListener |
| 消息发送 | tell 方法 | tell 方法 |

**ActorSystem 核心功能**：
- 管理多种类型 Actor (Player/Guild/Team)
- Caffeine LoadingCache 自动加载
- 过期自动保存 (RemovalListener)
- 统一的消息发送接口
- 监控指标暴露

#### Day 4: PlayerActor

| 任务 | 说明 | 产出 |
|------|------|------|
| PlayerActor | 玩家 Actor | PlayerActor.java |
| PlayerData | 玩家数据结构 | PlayerData.java |
| 消息处理 | 玩家相关消息处理 | handleMessage |
| 脏数据保存 | 保存到 Redis/MongoDB | saveData |

**PlayerActor 消息类型**：
- addExp - 增加经验
- addGold - 增加金币
- addItem - 添加物品
- removeItem - 移除物品
- equipItem - 装备物品
- getData - 获取数据

#### Day 5: GuildActor

| 任务 | 说明 | 产出 |
|------|------|------|
| GuildActor | 公会 Actor | GuildActor.java |
| GuildData | 公会数据结构 | GuildData.java |
| GuildMember | 成员数据结构 | GuildMember.java |
| 消息处理 | 公会相关消息处理 | handleMessage |
| 跨 Actor 通信 | 广播给成员 | broadcastToMembers |

**GuildActor 消息类型**：
- joinGuild - 加入公会
- leaveGuild - 退出公会
- donate - 成员捐献
- promoteMember - 提升职位
- kickMember - 踢出成员
- upgradeLevel - 公会升级

### 4.3 验收标准

- [ ] BaseActor 消息循环正常工作
- [ ] ActorSystem 可以创建、获取、销毁 Actor
- [ ] PlayerActor 可以处理基本消息
- [ ] GuildActor 可以处理成员操作
- [ ] Actor 过期时数据正确保存
- [ ] 单元测试覆盖率 >= 80%

---

## 5. 第三阶段：数据层 (Week 3)

### 5.1 目标

- 完成 framework-data 模块
- 完成 framework-log 模块
- 集成 Redis 和 MongoDB

### 5.2 任务清单

#### Day 1-2: framework-data (Redis)

| 任务 | 说明 | 产出 |
|------|------|------|
| Redis 配置 | Spring Data Redis 配置 | RedisConfig.java |
| RedisService | Redis 操作封装 | RedisService.java |
| 基础操作 | String/Hash/List/Set/ZSet | 方法封装 |
| 分布式锁 | Redis 分布式锁 | DistributedLock.java |
| 排行榜 | Sorted Set 封装 | RankService.java |

**RedisService 功能**：
- 基础 CRUD 操作
- 批量操作 (Pipeline)
- 分布式锁 (SET NX EX)
- 排行榜操作 (ZADD/ZRANGE)
- 消息队列 (Stream)

#### Day 3-4: framework-data (MongoDB)

| 任务 | 说明 | 产出 |
|------|------|------|
| MongoDB 配置 | Spring Data MongoDB 配置 | MongoConfig.java |
| BaseDocument | 文档基类 | BaseDocument.java |
| BaseRepository | 仓库基类 | BaseRepository.java |
| PlayerDataRepo | 玩家数据仓库 | PlayerDataRepository.java |
| GuildDataRepo | 公会数据仓库 | GuildDataRepository.java |
| 索引配置 | 自动创建索引 | @Indexed |

**BaseDocument 字段**：
- id (ObjectId)
- createTime
- updateTime

#### Day 5: framework-log

| 任务 | 说明 | 产出 |
|------|------|------|
| OperationLog | 操作日志实体 | OperationLog.java |
| LogType | 日志类型枚举 | LogType.java |
| OperationLogService | 异步批量写入 | OperationLogService.java |
| Logback 配置 | 日志输出配置 | logback-spring.xml |

**日志文件配置**：
- app.sls.log - 应用日志
- operation.sls.log - 操作日志
- access.sls.log - 访问日志
- error.sls.log - 错误日志

**OperationLogService 功能**：
- 异步批量写入 (BlockingQueue + 批量 Insert)
- 自动刷新 (1000条或1秒)
- 日志压缩 (JSON)

### 5.3 验收标准

- [ ] Redis 连接正常，基础操作可用
- [ ] MongoDB 连接正常，CRUD 可用
- [ ] 分布式锁功能正常
- [ ] 操作日志异步写入正常
- [ ] 日志文件正确输出

---

## 6. 第四阶段：网关与服务 (Week 4)

### 6.1 目标

- 完成 gateway-server
- 完成 service-api
- 完成 service-game
- 完成 service-guild

### 6.2 任务清单

#### Day 1: service-api

| 任务 | 说明 | 产出 |
|------|------|------|
| Proto 公共定义 | common.proto | 通用消息、错误码 |
| Proto 登录协议 | login.proto | 登录相关消息 |
| Proto 玩家协议 | player.proto | 玩家相关消息 |
| Proto 公会协议 | guild.proto | 公会相关消息 |
| Proto 编译配置 | Maven 插件配置 | protobuf-maven-plugin |
| PlayerService | 玩家服务接口 | PlayerService.java |
| GuildService | 公会服务接口 | GuildService.java |
| LoginService | 登录服务接口 | LoginService.java |
| ChatService | 聊天服务接口 | ChatService.java |
| 协议映射 | 协议号→处理方法 | ProtocolMapping |

**Protobuf 编译**：
- 使用 protobuf-maven-plugin 自动编译
- 生成 Java 类到 target/generated-sources
- 客户端使用相同 proto 文件生成对应语言代码

**接口设计原则**：
- 请求/响应使用 Protobuf 生成的类
- 内部服务间可使用 Java Record
- 返回统一 Result 结构

#### Day 2-3: gateway-server

| 任务 | 说明 | 产出 |
|------|------|------|
| Netty Server | TCP/WebSocket 服务器 | NettyServer.java |
| 协议编解码 | Protobuf 编解码器 | ProtobufCodec.java |
| Session 管理 | 连接会话管理 | SessionManager.java |
| Token 验证 | 权限过滤器 | AuthFilter.java |
| 限流过滤器 | 基于 Redis 限流 | RateLimitFilter.java |
| 路由转发 | 一致性哈希路由 | RouterHandler.java |
| Dubbo 消费者 | RPC 调用配置 | DubboConfig.java |

**网关处理流程**：
1. 接收连接 → 创建 Session
2. 接收数据 → 解码 Protobuf
3. Token 验证 → 限流检查
4. 路由选择 → Dubbo 调用
5. 返回结果 → 编码发送

#### Day 4: service-game

| 任务 | 说明 | 产出 |
|------|------|------|
| 应用主类 | Spring Boot 启动类 | GameServiceApplication.java |
| Dubbo 配置 | 服务提供者配置 | DubboConfig.java |
| PlayerServiceImpl | 玩家服务实现 | PlayerServiceImpl.java |
| 集成 ActorSystem | Actor 系统集成 | ActorConfig.java |

**PlayerServiceImpl 职责**：
- 获取 PlayerActor
- 发送消息到 Actor
- 等待处理结果
- 返回响应

#### Day 5: service-guild

| 任务 | 说明 | 产出 |
|------|------|------|
| 应用主类 | Spring Boot 启动类 | GuildServiceApplication.java |
| GuildServiceImpl | 公会服务实现 | GuildServiceImpl.java |
| 跨 Actor 通信 | Player-Guild 通信 | 消息处理 |

**GuildServiceImpl 职责**：
- 获取 GuildActor
- 发送消息到 Actor
- 处理跨 Actor 操作
- 返回响应

### 6.3 验收标准

- [ ] Gateway 可以接收 TCP/WebSocket 连接
- [ ] 协议编解码正确
- [ ] Token 验证功能正常
- [ ] 限流功能正常
- [ ] 路由转发到正确的服务实例
- [ ] service-game 注册到 Nacos
- [ ] service-guild 注册到 Nacos
- [ ] RPC 调用链路跑通
- [ ] 端到端流程验证通过

---

## 7. 第五阶段：支撑系统 (Week 5)

### 7.1 目标

- 完成 service-login
- 完成 service-chat
- 完成 service-rank
- 完成 service-task
- 完成 service-gm

### 7.2 任务清单

#### Day 1: service-login

| 任务 | 说明 | 产出 |
|------|------|------|
| 账号注册 | 用户名/密码注册 | register 方法 |
| 账号登录 | 登录验证 | login 方法 |
| Token 生成 | JWT Token | generateToken |
| Token 验证 | 验证并刷新 | verifyToken |
| 角色管理 | 角色创建/列表 | createRole/getRoles |

**数据存储**：
- MongoDB: account 集合
- Redis: token 缓存

#### Day 2: service-chat

| 任务 | 说明 | 产出 |
|------|------|------|
| 世界聊天 | 全服广播 | sendWorldChat |
| 公会聊天 | 公会内广播 | sendGuildChat |
| 私聊 | 点对点消息 | sendPrivateChat |
| 消息存储 | 持久化到 MongoDB | ChatMessage |

**实现方式**：
- Redis Stream 作为消息队列
- 消息异步持久化到 MongoDB
- TTL 7天自动删除

#### Day 3: service-rank

| 任务 | 说明 | 产出 |
|------|------|------|
| 更新排行 | 更新分数 | updateRank |
| 获取排行榜 | 分页查询 | getRankList |
| 获取排名 | 查询个人排名 | getPlayerRank |
| 排行奖励 | 发放奖励 | sendRankRewards |

**排行榜类型**：
- 等级排行榜
- 战力排行榜
- 公会排行榜

#### Day 4: service-task

| 任务 | 说明 | 产出 |
|------|------|------|
| XXL-Job 集成 | 任务调度配置 | XxlJobConfig.java |
| 数据保存任务 | saveAllActorData | GameScheduledTasks.java |
| 排行榜刷新 | refreshRankList | - |
| 邮件清理 | cleanExpiredMails | - |
| 配置检查 | reloadGameConfig | - |
| 在线统计 | statisticsOnline | - |

#### Day 5: service-gm

| 任务 | 说明 | 产出 |
|------|------|------|
| GM 账号管理 | 登录/权限 | GMAccountController |
| 玩家管理 | 查询/修改/封禁 | GMPlayerController |
| 公会管理 | 查询/解散 | GMGuildController |
| 邮件发送 | 全服/指定 | GMMailController |
| 配置管理 | 上传/热更新 | GMConfigController |
| 操作审计 | GM 日志记录 | GMLogAspect |

**技术实现**：
- Spring Boot Web
- Spring Security + JWT
- Swagger API 文档

### 7.3 验收标准

- [ ] 登录注册流程正常
- [ ] Token 验证正常
- [ ] 聊天功能可用
- [ ] 排行榜功能可用
- [ ] 定时任务正常执行
- [ ] GM 后台可以登录
- [ ] GM 玩家查询/修改可用
- [ ] GM 邮件发送可用
- [ ] GM 操作有审计日志

---

## 8. 第六阶段：集成测试 (Week 6)

### 8.1 目标

- 端到端集成测试
- 压力测试
- 性能优化
- 文档完善

### 8.2 任务清单

#### Day 1-2: 集成测试

| 任务 | 说明 | 产出 |
|------|------|------|
| 测试环境搭建 | Docker Compose 环境 | docker-compose.yml |
| 登录流程测试 | 注册→登录→选服→创角 | 测试报告 |
| 游戏流程测试 | 升级、背包、装备 | 测试报告 |
| 公会流程测试 | 创建→加入→捐献 | 测试报告 |
| 聊天流程测试 | 世界/公会/私聊 | 测试报告 |
| GM 功能测试 | 全部 GM 功能 | 测试报告 |

**测试场景**：
1. 正常流程测试
2. 异常流程测试
3. 边界条件测试
4. 并发场景测试

#### Day 3-4: 压力测试

| 任务 | 说明 | 产出 |
|------|------|------|
| 压测脚本 | JMeter/Gatling 脚本 | 脚本文件 |
| 登录压测 | 1000 并发登录 | 压测报告 |
| 游戏压测 | 10000 QPS | 压测报告 |
| 公会压测 | 并发操作测试 | 压测报告 |
| 性能分析 | CPU/内存/GC | 分析报告 |

**压测指标**：
| 指标 | 目标 |
|------|------|
| 登录 TPS | >= 1000 |
| 游戏 QPS | >= 10000 |
| 响应时间 P99 | < 50ms |
| 错误率 | < 0.1% |
| 内存占用 | < 4GB (1万在线) |

#### Day 5: 优化与文档

| 任务 | 说明 | 产出 |
|------|------|------|
| 性能优化 | 根据压测结果优化 | 代码优化 |
| JVM 调优 | GC 参数优化 | 启动参数 |
| 部署文档 | 部署步骤说明 | 部署文档 |
| 运维文档 | 运维手册 | 运维文档 |
| API 文档 | 接口文档 | Swagger 导出 |

### 8.3 验收标准

- [ ] 所有集成测试通过
- [ ] 压力测试达到目标指标
- [ ] 无内存泄漏
- [ ] 部署文档完整
- [ ] API 文档完整

---

## 9. 验收标准

### 9.1 功能验收

| 模块 | 验收项 | 标准 |
|------|--------|------|
| **framework-common** | 工具类 | 单元测试 100% |
| **framework-actor** | Actor 功能 | 消息处理正确 |
| **framework-data** | 数据读写 | CRUD 正常 |
| **gateway-server** | 网关功能 | 协议转换正确 |
| **service-game** | 游戏逻辑 | 业务流程正确 |
| **service-guild** | 公会逻辑 | 成员操作正确 |
| **service-login** | 登录逻辑 | Token 验证正确 |
| **service-task** | 定时任务 | 任务执行正确 |
| **service-gm** | GM 功能 | 操作生效 |

### 9.2 性能验收

| 指标 | 目标 | 测试方法 |
|------|------|---------|
| 网关吞吐量 | >= 50,000 QPS | JMeter 压测 |
| RPC 响应时间 | P99 < 20ms | 压测统计 |
| Actor 消息处理 | >= 100,000/s | 基准测试 |
| 内存占用 | < 4GB (1万在线) | JVM 监控 |
| GC 暂停时间 | P99 < 20ms | GC 日志 |
| 启动时间 | < 30s | 实测 |

### 9.3 代码质量

| 指标 | 标准 |
|------|------|
| 单元测试覆盖率 | >= 80% |
| 代码规范 | Checkstyle 0 Error |
| 文档覆盖 | 所有 Public API |
| 无严重 Bug | 0 Critical/Blocker |

---

## 10. 风险与应对

### 10.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| Actor 模型学习曲线 | 开发效率 | 提前学习、技术分享 |
| 虚拟线程兼容性 | 功能异常 | 充分测试、降级方案 |
| Dubbo 配置复杂 | 联调困难 | 参考官方示例 |
| MongoDB 性能 | 查询慢 | 索引优化、分片 |

### 10.2 进度风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 需求变更 | 延期 | 冻结核心功能 |
| 人员变动 | 延期 | 文档完善、代码规范 |
| 技术难题 | 延期 | 预留缓冲时间 |
| 联调问题 | 延期 | 提前集成测试 |

### 10.3 应急预案

| 场景 | 预案 |
|------|------|
| Week 2 Actor 框架延期 | 简化 GuildActor，先完成 PlayerActor |
| Week 4 网关开发延期 | 先使用 HTTP 接口验证，后补网关 |
| 压测不达标 | 优先保证功能，性能后续优化 |

---

## 附录

### A. 每日站会模板

```
1. 昨天完成了什么？
2. 今天计划做什么？
3. 有什么阻塞问题？
```

### B. 代码提交规范

```
类型(范围): 简短描述

feat: 新功能
fix: 修复 Bug
docs: 文档更新
refactor: 重构
test: 测试
chore: 构建/工具

示例:
feat(actor): 实现 PlayerActor 基础消息处理
fix(gateway): 修复 Token 验证失败问题
docs(api): 更新 PlayerService 接口文档
```

### C. 分支管理

```
main          - 主分支，稳定版本
develop       - 开发分支
feature/*     - 功能分支
fix/*         - 修复分支
release/*     - 发布分支
```

### D. Docker Compose 本地环境

```yaml
services:
  mongodb:
    image: mongo:7.0
    ports: ["27017:27017"]
    
  redis:
    image: redis:7.0-alpine
    ports: ["6379:6379"]
    
  nacos:
    image: nacos/nacos-server:v2.3.0
    ports: ["8848:8848"]
    environment:
      MODE: standalone
      
  xxl-job-admin:
    image: xuxueli/xxl-job-admin:2.4.0
    ports: ["8080:8080"]
```

---

**文档版本**: v3.0  
**最后更新**: 2024-01
