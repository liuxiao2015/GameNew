# æ•°æ®å±‚ä½¿ç”¨æŒ‡å—

> **æ¨¡å—**: `framework-data`  
> **åŠŸèƒ½**: MongoDB æŒä¹…åŒ– + Redis ç¼“å­˜  
> **ç‰ˆæœ¬**: v1.0

---

## ğŸ“š ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [MongoDB ä½¿ç”¨](#mongodb-ä½¿ç”¨)
3. [Redis ä½¿ç”¨](#redis-ä½¿ç”¨)
4. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

æ•°æ®å±‚æä¾›äº†ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ï¼ŒåŒ…æ‹¬ï¼š

| ç»„ä»¶ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|-----|------|---------|
| `BaseRepository` | MongoDB åŸºç¡€ä»“åº“ | ç©å®¶æ•°æ®ã€å…¬ä¼šæ•°æ®ç­‰æŒä¹…åŒ–å­˜å‚¨ |
| `RedisService` | Redis æœåŠ¡å°è£… | ç¼“å­˜ã€æ’è¡Œæ¦œã€åˆ†å¸ƒå¼é”ã€ä¼šè¯ |
| `QueryBuilder` | MongoDB æŸ¥è¯¢æ„å»ºå™¨ | å¤æ‚æ¡ä»¶æŸ¥è¯¢ |

---

## MongoDB ä½¿ç”¨

### 1. å®šä¹‰å®ä½“ç±»

```java
package com.game.service.game.entity;

import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

/**
 * ç©å®¶æ•°æ®å®ä½“
 */
@Data
@Document(collection = "player")
public class PlayerData {
    
    @Id
    private Long id;           // è§’è‰²ID (ä½¿ç”¨åˆ†å¸ƒå¼ID)
    
    private Long accountId;    // è´¦å·ID
    private String name;       // è§’è‰²å
    private int level;         // ç­‰çº§
    private long exp;          // ç»éªŒ
    private long gold;         // é‡‘å¸
    private long diamond;      // é’»çŸ³
    private int vipLevel;      // VIPç­‰çº§
    private long combatPower;  // æˆ˜æ–—åŠ›
    
    private long createTime;   // åˆ›å»ºæ—¶é—´
    private long updateTime;   // æ›´æ–°æ—¶é—´
    private long lastLoginTime; // æœ€åç™»å½•æ—¶é—´
}
```

### 2. åˆ›å»º Repository

```java
package com.game.service.game.repository;

import com.game.data.base.BaseRepository;
import com.game.service.game.entity.PlayerData;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.data.mongodb.core.query.Query;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

/**
 * ç©å®¶æ•°æ®ä»“åº“
 */
@Repository
public class PlayerRepository extends BaseRepository<PlayerData, Long> {

    public PlayerRepository(MongoTemplate mongoTemplate) {
        super(mongoTemplate, PlayerData.class);
    }

    // ==================== è‡ªå®šä¹‰æŸ¥è¯¢ ====================

    /**
     * æ ¹æ®è´¦å·IDæŸ¥è¯¢è§’è‰²
     */
    public List<PlayerData> findByAccountId(Long accountId) {
        return findByField("accountId", accountId);
    }

    /**
     * æ ¹æ®åå­—æŸ¥è¯¢è§’è‰²
     */
    public Optional<PlayerData> findByName(String name) {
        return findOneByField("name", name);
    }

    /**
     * æŸ¥è¯¢ç­‰çº§å¤§äºæŒ‡å®šå€¼çš„ç©å®¶
     */
    public List<PlayerData> findByLevelGreaterThan(int level, int limit) {
        Query query = new Query(Criteria.where("level").gt(level))
                .with(Sort.by(Sort.Direction.DESC, "level"))
                .limit(limit);
        return find(query);
    }

    /**
     * è·å–æˆ˜åŠ›æ’è¡Œæ¦œ
     */
    public List<PlayerData> getTopPlayers(int limit) {
        return findAll(Sort.by(Sort.Direction.DESC, "combatPower"), limit);
    }

    /**
     * æŸ¥è¯¢åœ¨çº¿ç©å®¶ (æŒ‰æœ€åç™»å½•æ—¶é—´)
     */
    public List<PlayerData> findRecentOnline(long sinceTime) {
        Query query = new Query(Criteria.where("lastLoginTime").gte(sinceTime));
        return find(query);
    }

    /**
     * æ£€æŸ¥åå­—æ˜¯å¦å·²å­˜åœ¨
     */
    public boolean isNameExists(String name) {
        return existsByField("name", name);
    }
}
```

### 3. BaseRepository å¸¸ç”¨æ–¹æ³•

```java
// ==================== CRUD æ“ä½œ ====================

// æ ¹æ® ID æŸ¥è¯¢
Optional<PlayerData> player = playerRepository.findById(roleId);
PlayerData player = playerRepository.getById(roleId);  // å¯èƒ½è¿”å› null

// ä¿å­˜ (æ–°å¢æˆ–æ›´æ–°)
playerRepository.save(playerData);

// æ‰¹é‡ä¿å­˜
playerRepository.saveAll(List.of(player1, player2, player3));

// åˆ é™¤
playerRepository.deleteById(roleId);
playerRepository.delete(playerData);

// åˆ¤æ–­æ˜¯å¦å­˜åœ¨
boolean exists = playerRepository.existsById(roleId);

// ç»Ÿè®¡æ•°é‡
long count = playerRepository.count();


// ==================== æŸ¥è¯¢æ“ä½œ ====================

// æŸ¥è¯¢æ‰€æœ‰
List<PlayerData> all = playerRepository.findAll();

// å¸¦æ’åºæŸ¥è¯¢
List<PlayerData> sorted = playerRepository.findAll(Sort.by(Sort.Direction.DESC, "level"));

// å¸¦æ’åºå’Œé™åˆ¶
List<PlayerData> top10 = playerRepository.findAll(Sort.by(Sort.Direction.DESC, "combatPower"), 10);

// åˆ†é¡µæŸ¥è¯¢
List<PlayerData> page = playerRepository.findPage(0, 20);  // ç¬¬1é¡µï¼Œæ¯é¡µ20æ¡
List<PlayerData> page = playerRepository.findPage(1, 20, Sort.by("level"));  // å¸¦æ’åº

// æŒ‰å­—æ®µæŸ¥è¯¢
Optional<PlayerData> byName = playerRepository.findOneByField("name", "å¼ ä¸‰");
List<PlayerData> byLevel = playerRepository.findByField("level", 50);


// ==================== æ›´æ–°æ“ä½œ ====================

// æ›´æ–°å•ä¸ªå­—æ®µ
playerRepository.updateField(roleId, "level", 51);

// å­—æ®µè‡ªå¢
playerRepository.incrementField(roleId, "exp", 1000);  // exp += 1000

// æ‰¹é‡æ›´æ–°
playerRepository.updateFieldBatch(List.of(id1, id2, id3), "vipLevel", 1);


// ==================== è‡ªå®šä¹‰æŸ¥è¯¢ ====================

// ä½¿ç”¨ Query å¯¹è±¡
Query query = new Query()
    .addCriteria(Criteria.where("level").gte(50).lte(100))
    .addCriteria(Criteria.where("vipLevel").gt(0))
    .with(Sort.by(Sort.Direction.DESC, "combatPower"))
    .limit(100);
    
List<PlayerData> result = playerRepository.find(query);

// ä½¿ç”¨ Update å¯¹è±¡
Query query = new Query(Criteria.where("_id").is(roleId));
Update update = new Update()
    .set("level", 51)
    .inc("exp", 1000)
    .set("updateTime", System.currentTimeMillis());
    
playerRepository.update(query, update);
```

---

## Redis ä½¿ç”¨

### 1. æ³¨å…¥ RedisService

```java
@Service
@RequiredArgsConstructor
public class PlayerCacheService {
    
    private final RedisService redisService;
    
    // ... ä½¿ç”¨ redisService
}
```

### 2. String æ“ä½œ

```java
// ==================== åŸºç¡€æ“ä½œ ====================

// è®¾ç½®å€¼
redisService.set("player:name:12345", "å¼ ä¸‰");

// è®¾ç½®å€¼å¹¶æŒ‡å®šè¿‡æœŸæ—¶é—´
redisService.set("session:token123", "data", Duration.ofHours(1));
redisService.set("session:token123", "data", 3600);  // ç§’

// è·å–å€¼
String name = redisService.get("player:name:12345");


// ==================== å¯¹è±¡æ“ä½œ (è‡ªåŠ¨JSONåºåˆ—åŒ–) ====================

// å­˜å‚¨å¯¹è±¡
PlayerDTO player = new PlayerDTO(12345, "å¼ ä¸‰", 50);
redisService.setObject("player:info:12345", player);
redisService.setObject("player:info:12345", player, Duration.ofMinutes(30));

// è·å–å¯¹è±¡
PlayerDTO player = redisService.getObject("player:info:12345", PlayerDTO.class);


// ==================== åŸå­æ“ä½œ ====================

// åªæœ‰é”®ä¸å­˜åœ¨æ—¶æ‰è®¾ç½® (åˆ†å¸ƒå¼é”åŸºç¡€)
boolean success = redisService.setIfAbsent("lock:order:12345", "1");
boolean success = redisService.setIfAbsent("lock:order:12345", "1", Duration.ofSeconds(10));

// è‡ªå¢/è‡ªå‡
Long count = redisService.increment("daily:login:count");
Long count = redisService.increment("player:12345:gold", 100);  // +100
Long count = redisService.decrement("player:12345:gold");       // -1
```

### 3. Hash æ“ä½œ

```java
// ==================== Hash æ“ä½œ (é€‚åˆå­˜å‚¨å¯¹è±¡å­—æ®µ) ====================

// è®¾ç½®å•ä¸ªå­—æ®µ
redisService.hSet("player:12345", "name", "å¼ ä¸‰");
redisService.hSet("player:12345", "level", "50");

// è®¾ç½®å¯¹è±¡å­—æ®µ (è‡ªåŠ¨JSONåºåˆ—åŒ–)
redisService.hSetObject("player:12345", "bag", bagData);

// æ‰¹é‡è®¾ç½®
Map<String, String> fields = Map.of("name", "å¼ ä¸‰", "level", "50", "vip", "1");
redisService.hSetAll("player:12345", fields);

// è·å–å•ä¸ªå­—æ®µ
String name = redisService.hGet("player:12345", "name");
BagData bag = redisService.hGetObject("player:12345", "bag", BagData.class);

// è·å–æ‰€æœ‰å­—æ®µ
Map<String, String> all = redisService.hGetAll("player:12345");

// å­—æ®µè‡ªå¢
Long newLevel = redisService.hIncrement("player:12345", "level", 1);

// åˆ é™¤å­—æ®µ
redisService.hDelete("player:12345", "tempData", "cache");

// åˆ¤æ–­å­—æ®µæ˜¯å¦å­˜åœ¨
boolean exists = redisService.hHasKey("player:12345", "name");
```

### 4. Set æ“ä½œ

```java
// ==================== Set æ“ä½œ (æ— åºé›†åˆï¼Œå»é‡) ====================

// æ·»åŠ æˆå‘˜
redisService.sAdd("online:players", "12345", "12346", "12347");

// ç§»é™¤æˆå‘˜
redisService.sRemove("online:players", "12345");

// åˆ¤æ–­æˆå‘˜æ˜¯å¦å­˜åœ¨
boolean online = redisService.sIsMember("online:players", "12345");

// è·å–æ‰€æœ‰æˆå‘˜
Set<String> onlinePlayers = redisService.sMembers("online:players");

// è·å–æˆå‘˜æ•°é‡
Long count = redisService.sSize("online:players");
```

### 5. ZSet æ“ä½œ (æ’è¡Œæ¦œ)

```java
// ==================== ZSet æ“ä½œ (æœ‰åºé›†åˆï¼Œæ’è¡Œæ¦œ) ====================

// æ·»åŠ æˆå‘˜ (åˆ†æ•°)
redisService.zAdd("rank:combat", "12345", 100000.0);  // ç©å®¶12345ï¼Œæˆ˜åŠ›100000
redisService.zAdd("rank:combat", "12346", 150000.0);

// å¢åŠ åˆ†æ•°
Double newScore = redisService.zIncrementScore("rank:combat", "12345", 5000.0);

// è·å–æ’å (ä»0å¼€å§‹ï¼Œåˆ†æ•°ä»é«˜åˆ°ä½)
Long rank = redisService.zReverseRank("rank:combat", "12345");  // ç¬¬å‡ å

// è·å–åˆ†æ•°
Double score = redisService.zScore("rank:combat", "12345");

// è·å–æ’è¡Œæ¦œ (åˆ†æ•°ä»é«˜åˆ°ä½)
Set<String> top10 = redisService.zReverseRange("rank:combat", 0, 9);

// è·å–æ’è¡Œæ¦œ (å¸¦åˆ†æ•°)
Set<ZSetOperations.TypedTuple<String>> top10 = 
    redisService.zReverseRangeWithScores("rank:combat", 0, 9);
    
for (ZSetOperations.TypedTuple<String> tuple : top10) {
    String playerId = tuple.getValue();
    Double combatPower = tuple.getScore();
    System.out.println(playerId + ": " + combatPower);
}

// ç§»é™¤æˆå‘˜
redisService.zRemove("rank:combat", "12345");

// è·å–æˆå‘˜æ•°é‡
Long count = redisService.zSize("rank:combat");
```

### 6. List æ“ä½œ

```java
// ==================== List æ“ä½œ (æœ‰åºåˆ—è¡¨ï¼Œæ¶ˆæ¯é˜Ÿåˆ—) ====================

// å·¦ä¾§æ·»åŠ  (å¤´éƒ¨)
redisService.lLeftPush("msg:queue:12345", "æ¶ˆæ¯1");

// å³ä¾§æ·»åŠ  (å°¾éƒ¨)
redisService.lRightPush("msg:queue:12345", "æ¶ˆæ¯2");

// å·¦ä¾§å¼¹å‡º (FIFO)
String msg = redisService.lLeftPop("msg:queue:12345");

// å³ä¾§å¼¹å‡º (LIFO)
String msg = redisService.lRightPop("msg:queue:12345");

// è·å–èŒƒå›´
List<String> messages = redisService.lRange("msg:queue:12345", 0, -1);  // å…¨éƒ¨

// è·å–é•¿åº¦
Long size = redisService.lSize("msg:queue:12345");
```

### 7. é”®æ“ä½œ

```java
// ==================== é”®æ“ä½œ ====================

// åˆ é™¤é”®
redisService.delete("player:12345");

// æ‰¹é‡åˆ é™¤
redisService.delete(List.of("key1", "key2", "key3"));

// åˆ¤æ–­é”®æ˜¯å¦å­˜åœ¨
boolean exists = redisService.hasKey("player:12345");

// è®¾ç½®è¿‡æœŸæ—¶é—´
redisService.expire("session:12345", Duration.ofHours(1));
redisService.expire("session:12345", 3600);  // ç§’

// è·å–å‰©ä½™è¿‡æœŸæ—¶é—´ (ç§’)
Long ttl = redisService.getExpire("session:12345");
```

### 8. åˆ†å¸ƒå¼é”

```java
// ==================== åˆ†å¸ƒå¼é” ====================

String lockKey = "lock:player:12345:bag";
String requestId = UUID.randomUUID().toString();

try {
    // å°è¯•è·å–é” (10ç§’è¿‡æœŸ)
    boolean locked = redisService.tryLock(lockKey, requestId, Duration.ofSeconds(10));
    
    if (!locked) {
        throw new BizException(ErrorCode.SYSTEM_BUSY);
    }
    
    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    processBagOperation();
    
} finally {
    // é‡Šæ”¾é”
    redisService.releaseLock(lockKey, requestId);
}
```

### 9. å‘å¸ƒ/è®¢é˜…

```java
// å‘å¸ƒæ¶ˆæ¯åˆ°é¢‘é“
redisService.publish("game:event:levelup", "{\"roleId\":12345,\"level\":51}");
```

---

## æœ€ä½³å®è·µ

### 1. Redis Key å‘½åè§„èŒƒ

```java
public class RedisKeys {
    
    // æ ¼å¼: ä¸šåŠ¡:ç±»å‹:ID
    
    // ç©å®¶ç›¸å…³
    public static String playerInfo(long roleId) {
        return "player:info:" + roleId;
    }
    
    public static String playerSession(long roleId) {
        return "player:session:" + roleId;
    }
    
    // å…¬ä¼šç›¸å…³
    public static String guildInfo(long guildId) {
        return "guild:info:" + guildId;
    }
    
    // æ’è¡Œæ¦œ
    public static String rankCombat() {
        return "rank:combat";
    }
    
    // åˆ†å¸ƒå¼é”
    public static String lockPlayer(long roleId) {
        return "lock:player:" + roleId;
    }
    
    // åœ¨çº¿ç©å®¶
    public static String onlinePlayers() {
        return "online:players";
    }
}
```

### 2. ç¼“å­˜ç­–ç•¥

```java
@Service
@RequiredArgsConstructor
public class PlayerCacheService {

    private final RedisService redisService;
    private final PlayerRepository playerRepository;

    private static final Duration CACHE_TTL = Duration.ofMinutes(30);

    /**
     * è·å–ç©å®¶ä¿¡æ¯ (ç¼“å­˜ä¼˜å…ˆ)
     */
    public PlayerDTO getPlayer(long roleId) {
        String key = RedisKeys.playerInfo(roleId);
        
        // 1. å…ˆä»ç¼“å­˜è·å–
        PlayerDTO cached = redisService.getObject(key, PlayerDTO.class);
        if (cached != null) {
            return cached;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
        PlayerData data = playerRepository.getById(roleId);
        if (data == null) {
            return null;
        }
        
        // 3. è½¬æ¢å¹¶å†™å…¥ç¼“å­˜
        PlayerDTO dto = convertToDTO(data);
        redisService.setObject(key, dto, CACHE_TTL);
        
        return dto;
    }

    /**
     * æ›´æ–°ç©å®¶ä¿¡æ¯ (åŒæ—¶æ›´æ–°ç¼“å­˜)
     */
    public void updatePlayer(PlayerData data) {
        // 1. æ›´æ–°æ•°æ®åº“
        playerRepository.save(data);
        
        // 2. æ›´æ–°ç¼“å­˜ (æˆ–ç›´æ¥åˆ é™¤ï¼Œä¸‹æ¬¡è¯»å–æ—¶é‡å»º)
        String key = RedisKeys.playerInfo(data.getId());
        redisService.delete(key);  // åˆ é™¤ç¼“å­˜ï¼Œä¸‹æ¬¡è¯»å–æ—¶é‡å»º
    }
}
```

### 3. äº‹åŠ¡æ“ä½œ

```java
@Service
public class TransactionService {

    @Autowired
    private MongoTemplate mongoTemplate;

    /**
     * ä½¿ç”¨ MongoDB äº‹åŠ¡
     */
    public void transferGold(long fromRoleId, long toRoleId, long gold) {
        mongoTemplate.executeInSession(session -> {
            session.startTransaction();
            try {
                // æ‰£é™¤é‡‘å¸
                Query query1 = new Query(Criteria.where("_id").is(fromRoleId));
                Update update1 = new Update().inc("gold", -gold);
                mongoTemplate.updateFirst(query1, update1, PlayerData.class);
                
                // å¢åŠ é‡‘å¸
                Query query2 = new Query(Criteria.where("_id").is(toRoleId));
                Update update2 = new Update().inc("gold", gold);
                mongoTemplate.updateFirst(query2, update2, PlayerData.class);
                
                session.commitTransaction();
                return null;
            } catch (Exception e) {
                session.abortTransaction();
                throw e;
            }
        });
    }
}
```

---

## å¸¸è§é—®é¢˜

### Q1: MongoDB å’Œ Redis å¦‚ä½•é€‰æ‹©ï¼Ÿ

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | è¯´æ˜ |
|---------|---------|------|
| ç©å®¶æ ¸å¿ƒæ•°æ® | MongoDB | éœ€è¦æŒä¹…åŒ–çš„é‡è¦æ•°æ® |
| ä¸´æ—¶ä¼šè¯ | Redis | è¿‡æœŸè‡ªåŠ¨æ¸…ç† |
| æ’è¡Œæ¦œ | Redis ZSet | å®æ—¶æ’åæŸ¥è¯¢ |
| åœ¨çº¿çŠ¶æ€ | Redis Set | å¿«é€Ÿåˆ¤æ–­åœ¨çº¿ |
| ç¼“å­˜ | Redis | å‡å°‘æ•°æ®åº“å‹åŠ› |
| åˆ†å¸ƒå¼é” | Redis | è·¨æœåŠ¡äº’æ–¥ |

### Q2: å¦‚ä½•å¤„ç†ç¼“å­˜ç©¿é€ï¼Ÿ

```java
// ä½¿ç”¨ç©ºå€¼ç¼“å­˜
public PlayerDTO getPlayer(long roleId) {
    String key = RedisKeys.playerInfo(roleId);
    String cached = redisService.get(key);
    
    // ç©ºå€¼æ ‡è®°
    if ("NULL".equals(cached)) {
        return null;
    }
    
    if (cached != null) {
        return JsonUtil.fromJson(cached, PlayerDTO.class);
    }
    
    PlayerData data = playerRepository.getById(roleId);
    if (data == null) {
        // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€
        redisService.set(key, "NULL", Duration.ofMinutes(5));
        return null;
    }
    
    PlayerDTO dto = convertToDTO(data);
    redisService.setObject(key, dto, CACHE_TTL);
    return dto;
}
```
