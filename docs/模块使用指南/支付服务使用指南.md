# 支付服务使用指南

## 概述

支付服务 (`service-pay`) 提供完整的游戏内购支付解决方案，包括：
- 订单创建与管理
- 多渠道支付回调处理
- 道具自动发放
- 支付数据统计

## 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                        支付服务架构                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │  客户端  │  │  微信   │  │ 支付宝  │  │ 苹果/谷歌│            │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘            │
│       │            │            │            │                  │
│       ▼            ▼            ▼            ▼                  │
│  ┌─────────────────────────────────────────────────────┐       │
│  │              PayCallbackController                   │       │
│  └──────────────────────┬──────────────────────────────┘       │
│                         │                                       │
│                         ▼                                       │
│  ┌─────────────────────────────────────────────────────┐       │
│  │              PayChannelFactory                       │       │
│  │  ┌──────────┬──────────┬──────────┬──────────┐      │       │
│  │  │ Wechat   │ Alipay   │ Apple    │ Mock     │      │       │
│  │  │ Adapter  │ Adapter  │ Adapter  │ Adapter  │      │       │
│  │  └──────────┴──────────┴──────────┴──────────┘      │       │
│  └──────────────────────┬──────────────────────────────┘       │
│                         │                                       │
│                         ▼                                       │
│  ┌─────────────────────────────────────────────────────┐       │
│  │   PayServiceImpl     │   PayCallbackService         │       │
│  │   (订单创建/查询)     │   (回调处理)                 │       │
│  └──────────────────────┬──────────────────────────────┘       │
│                         │                                       │
│                         ▼                                       │
│  ┌─────────────────────────────────────────────────────┐       │
│  │                 DeliverService                       │       │
│  │                 (道具发放)                           │       │
│  └──────────────────────┬──────────────────────────────┘       │
│                         │                                       │
│                         ▼                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   PayOrder   │  │   Product    │  │  PayRecord   │          │
│  │   (订单表)    │  │   (商品表)   │  │  (记录表)    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

## 订单状态流转

```
┌─────────┐
│ PENDING │ ─── 待支付
└────┬────┘
     │ 发起支付
     ▼
┌─────────┐
│ PAYING  │ ─── 支付中
└────┬────┘
     │
     ├───────────────┬───────────────┬───────────────┐
     │ 支付成功       │ 超时           │ 取消          │
     ▼               ▼               ▼               │
┌─────────┐    ┌─────────┐    ┌─────────┐           │
│  PAID   │    │ EXPIRED │    │CANCELLED│           │
└────┬────┘    └─────────┘    └─────────┘           │
     │ 发放道具                                      │
     ▼                                              │
┌─────────┐                                         │
│DELIVERING│ ─── 发放中                              │
└────┬────┘                                         │
     │                                              │
     ├───────────────┐                              │
     │ 发放成功       │ 发放失败                      │
     ▼               ▼                              │
┌─────────┐    ┌─────────┐                         │
│COMPLETED│    │ FAILED  │ ─── 需要人工处理         │
└─────────┘    └─────────┘                         │
```

## 快速开始

### 1. 创建订单

```java
@DubboReference
private PayService payService;

public OrderDTO createOrder(long roleId, int productId, String channel) {
    CreateOrderRequest request = CreateOrderRequest.builder()
        .roleId(roleId)
        .accountId(accountId)
        .serverId(serverId)
        .productId(productId)
        .channel(channel)  // wechat, alipay, apple, google, mock
        .platform("android")
        .clientIp("127.0.0.1")
        .build();
    
    Result<OrderDTO> result = payService.createOrder(request);
    if (result.isSuccess()) {
        OrderDTO order = result.getData();
        // 返回支付参数给客户端
        return order;
    }
    throw new BizException(result.getCode(), result.getMessage());
}
```

### 2. 客户端唤起支付

```javascript
// 微信支付 (iOS/Android)
const payParams = order.payParams;
wx.requestPayment({
    timeStamp: payParams.timestamp,
    nonceStr: payParams.nonceStr,
    package: `prepay_id=${payParams.prepayId}`,
    signType: 'MD5',
    paySign: payParams.sign,
    success: () => { /* 支付成功 */ },
    fail: () => { /* 支付失败 */ }
});

// 支付宝 (需要服务端返回 orderString)
AlipaySDK.pay(order.payParams.orderString);
```

### 3. 配置支付回调地址

在支付平台配置回调地址：

| 渠道 | 回调地址 |
|------|---------|
| 微信支付 | `https://your-domain.com/pay/callback/wechat` |
| 支付宝 | `https://your-domain.com/pay/callback/alipay` |
| 苹果内购 | `https://your-domain.com/pay/callback/apple` |
| Google Play | `https://your-domain.com/pay/callback/google` |

### 4. 配置支付参数

```yaml
# application.yml
pay:
  order-expire-minutes: 30  # 订单过期时间
  
  wechat:
    enabled: true
    app-id: ${WECHAT_APP_ID}
    mch-id: ${WECHAT_MCH_ID}
    api-key: ${WECHAT_API_KEY}
    notify-url: https://your-domain.com/pay/callback/wechat
  
  alipay:
    enabled: true
    app-id: ${ALIPAY_APP_ID}
    private-key: ${ALIPAY_PRIVATE_KEY}
    public-key: ${ALIPAY_PUBLIC_KEY}
    notify-url: https://your-domain.com/pay/callback/alipay
```

## 商品配置

### 商品表结构

```java
@Document(collection = "pay_product")
public class Product {
    private int productId;           // 商品ID
    private String name;             // 商品名称
    private BigDecimal price;        // 价格 (元)
    private int type;                // 类型: 1充值 2礼包 3月卡
    private List<ProductReward> rewards;        // 道具奖励
    private List<ProductReward> firstBuyRewards; // 首充额外奖励
    private int buyLimit;            // 限购次数 (0=不限)
    private int dailyLimit;          // 每日限购
    private boolean enabled;         // 是否上架
}
```

### 配置商品示例

```javascript
// MongoDB 商品配置
db.pay_product.insertMany([
    {
        productId: 1001,
        name: "60钻石",
        price: NumberDecimal("6.00"),
        currency: "CNY",
        type: 1,  // 充值
        rewards: [
            { type: 2, itemId: 10001, count: 60 }  // 钻石
        ],
        firstBuyRewards: [
            { type: 2, itemId: 10001, count: 60 }  // 首充双倍
        ],
        enabled: true,
        sortOrder: 1
    },
    {
        productId: 1002,
        name: "328钻石",
        price: NumberDecimal("30.00"),
        currency: "CNY",
        type: 1,
        rewards: [
            { type: 2, itemId: 10001, count: 328 }
        ],
        firstBuyRewards: [
            { type: 2, itemId: 10001, count: 328 }
        ],
        enabled: true,
        sortOrder: 2
    },
    {
        productId: 2001,
        name: "新手礼包",
        price: NumberDecimal("6.00"),
        currency: "CNY",
        type: 2,  // 礼包
        rewards: [
            { type: 2, itemId: 10001, count: 100 },
            { type: 2, itemId: 20001, count: 10 }
        ],
        buyLimit: 1,  // 限购1次
        enabled: true,
        sortOrder: 100
    }
]);
```

## 道具发放

### 奖励类型

| type | 说明 | itemId 含义 |
|------|------|------------|
| 1 | 货币 | 1=金币, 2=钻石 |
| 2 | 道具 | 道具ID |
| 3 | VIP经验 | - |

### 发放流程

```
支付成功 → 创建支付记录 → 更新订单状态 → 异步发放道具
                                              ↓
                                      发放成功 → 完成
                                      发放失败 → 重试 (最多3次)
                                              ↓
                                      重试失败 → 标记失败，人工处理
```

### 补发道具 (GM)

```java
// 通过 PayService.redeliverOrder
payService.redeliverOrder("订单号", "GM操作员");
```

## 支付事件

```java
// 监听支付成功事件
@EventListener
public void onPaySuccess(PayEvents.PaySuccessEvent event) {
    log.info("支付成功: roleId={}, orderId={}, amount={}", 
        event.getRoleId(), event.getOrderId(), event.getAmount());
    
    // 更新VIP等级
    // 发放额外奖励
    // 触发成就
}

// 监听首充事件
@EventListener
public void onFirstPay(PayEvents.FirstPayEvent event) {
    log.info("首充: roleId={}, orderId={}", 
        event.getRoleId(), event.getOrderId());
    
    // 发放首充奖励
    // 开启首充活动
}
```

## 测试支付

开发环境可使用模拟支付：

```bash
# 模拟支付回调
curl -X POST "http://localhost:9060/pay/callback/mock?orderId=订单号&amount=6.00"
```

## 安全建议

1. **HTTPS**: 回调地址必须使用 HTTPS
2. **IP白名单**: 配置支付平台的回调IP白名单
3. **签名验证**: 所有回调必须验证签名
4. **幂等处理**: 支持重复回调的幂等处理
5. **金额校验**: 回调金额必须与订单金额一致
6. **日志记录**: 记录所有支付相关日志

## 常见问题

### Q: 支付成功但道具未发放？
1. 检查订单状态是否为 `DELIVERING` 或 `FAILED`
2. 查看 `deliverRetryCount` 是否已达上限
3. 使用 GM 工具补发

### Q: 如何添加新的支付渠道？
1. 实现 `PayChannelAdapter` 接口
2. 添加 `@Component` 注解
3. 配置渠道参数

### Q: 如何处理退款？
目前需要手动处理退款，未来可扩展 `refund` 接口。
