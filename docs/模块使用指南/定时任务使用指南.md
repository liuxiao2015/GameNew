# å®šæ—¶ä»»åŠ¡ä½¿ç”¨æŒ‡å—

> **æ¨¡å—**: `service-scheduler`  
> **æ¡†æ¶**: XXL-Job  
> **åŠŸèƒ½**: åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦  
> **ç‰ˆæœ¬**: v1.0

---

## ğŸ“š ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [ä»»åŠ¡ç±»å‹](#ä»»åŠ¡ç±»å‹)
4. [ä»»åŠ¡å¼€å‘](#ä»»åŠ¡å¼€å‘)
5. [é«˜çº§ç‰¹æ€§](#é«˜çº§ç‰¹æ€§)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

ä½¿ç”¨ XXL-Job ä½œä¸ºåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶ï¼Œæ”¯æŒï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| **å¯è§†åŒ–ç®¡ç†** | Web ç•Œé¢ç®¡ç†ä»»åŠ¡ |
| **åˆ†å¸ƒå¼è°ƒåº¦** | æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé¿å…é‡å¤æ‰§è¡Œ |
| **å¤±è´¥é‡è¯•** | ä»»åŠ¡å¤±è´¥è‡ªåŠ¨é‡è¯• |
| **ä»»åŠ¡åˆ†ç‰‡** | å¤§ä»»åŠ¡æ‹†åˆ†å¹¶è¡Œæ‰§è¡Œ |
| **æ—¥å¿—è¿½è¸ª** | å®æ—¶æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¥å¿— |
| **å‘Šè­¦é€šçŸ¥** | ä»»åŠ¡å¤±è´¥å‘Šè­¦ |

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    XXL-Job Admin                            â”‚
â”‚  (ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒ - ç®¡ç†ä»»åŠ¡ã€è§¦å‘æ‰§è¡Œã€æŸ¥çœ‹æ—¥å¿—)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    è°ƒåº¦è§¦å‘ (HTTP)
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scheduler-1   â”‚    â”‚ Scheduler-2   â”‚    â”‚ Scheduler-N   â”‚
â”‚ (æ‰§è¡Œå™¨å®ä¾‹)  â”‚    â”‚ (æ‰§è¡Œå™¨å®ä¾‹)  â”‚    â”‚ (æ‰§è¡Œå™¨å®ä¾‹)  â”‚
â”‚               â”‚    â”‚               â”‚    â”‚               â”‚
â”‚ @XxlJob       â”‚    â”‚ @XxlJob       â”‚    â”‚ @XxlJob       â”‚
â”‚ dailyReset    â”‚    â”‚ dailyReset    â”‚    â”‚ dailyReset    â”‚
â”‚ rankSnapshot  â”‚    â”‚ rankSnapshot  â”‚    â”‚ rankSnapshot  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¿«é€Ÿå¼€å§‹

### 1. é…ç½® XXL-Job

`application.yml`:

```yaml
xxl:
  job:
    admin:
      addresses: http://xxl-job-admin:8080/xxl-job-admin
    executor:
      appname: game-scheduler
      address:
      ip:
      port: 9999
      logpath: /logs/xxl-job
      logretentiondays: 7
    accessToken: game-server-token
```

### 2. åˆ›å»ºæ‰§è¡Œå™¨é…ç½®

```java
package com.game.service.scheduler.config;

import com.xxl.job.core.executor.impl.XxlJobSpringExecutor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Slf4j
@Configuration
public class XxlJobConfig {

    @Value("${xxl.job.admin.addresses}")
    private String adminAddresses;

    @Value("${xxl.job.executor.appname}")
    private String appname;

    @Value("${xxl.job.executor.port}")
    private int port;

    @Value("${xxl.job.accessToken}")
    private String accessToken;

    @Bean
    public XxlJobSpringExecutor xxlJobExecutor() {
        log.info("åˆå§‹åŒ– XXL-Job æ‰§è¡Œå™¨ appname={}, adminAddresses={}", appname, adminAddresses);
        
        XxlJobSpringExecutor executor = new XxlJobSpringExecutor();
        executor.setAdminAddresses(adminAddresses);
        executor.setAppname(appname);
        executor.setPort(port);
        executor.setAccessToken(accessToken);
        executor.setLogRetentionDays(7);
        
        return executor;
    }
}
```

### 3. åˆ›å»ºä»»åŠ¡ Handler

```java
package com.game.service.scheduler.job;

import com.xxl.job.core.handler.annotation.XxlJob;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class DemoJob {

    /**
     * ç®€å•ä»»åŠ¡ç¤ºä¾‹
     * XXL-Job é…ç½®: JobHandler å¡«å†™ "demoHandler"
     */
    @XxlJob("demoHandler")
    public void demo() {
        log.info("Demo ä»»åŠ¡æ‰§è¡Œ");
    }
}
```

---

## ä»»åŠ¡ç±»å‹

### 1. æ¯æ—¥é‡ç½®ä»»åŠ¡

```java
package com.game.service.scheduler.job;

import com.game.api.guild.GuildService;
import com.game.api.player.PlayerService;
import com.game.common.result.Result;
import com.game.core.event.DistributedEventBus;
import com.game.data.redis.RedisService;
import com.xxl.job.core.context.XxlJobHelper;
import com.xxl.job.core.handler.annotation.XxlJob;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.dubbo.config.annotation.DubboReference;
import org.springframework.stereotype.Component;

import java.time.LocalDate;

/**
 * æ¯æ—¥é‡ç½®ä»»åŠ¡
 * <p>
 * Cron: 0 0 0 * * ?  (æ¯å¤©é›¶ç‚¹æ‰§è¡Œ)
 * </p>
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class DailyResetJob {

    private final RedisService redisService;
    private final DistributedEventBus distributedEventBus;

    @DubboReference(check = false)
    private PlayerService playerService;

    @DubboReference(check = false)
    private GuildService guildService;

    @XxlJob("dailyResetHandler")
    public void dailyReset() {
        String today = LocalDate.now().toString();
        String lockKey = "scheduler:daily_reset:" + today;

        XxlJobHelper.log("å¼€å§‹æ‰§è¡Œæ¯æ—¥é‡ç½®ä»»åŠ¡: {}", today);
        long startTime = System.currentTimeMillis();

        // é˜²æ­¢é‡å¤æ‰§è¡Œ
        Boolean alreadyDone = redisService.setIfAbsent(lockKey, "1", 3600 * 24);
        if (!Boolean.TRUE.equals(alreadyDone)) {
            XxlJobHelper.log("æ¯æ—¥é‡ç½®ä»»åŠ¡å·²æ‰§è¡Œè¿‡ï¼Œè·³è¿‡");
            return;
        }

        try {
            // 1. é‡ç½®ç©å®¶æ•°æ®
            XxlJobHelper.log("æ­¥éª¤ 1: é‡ç½®ç©å®¶æ¯æ—¥æ•°æ®...");
            Result<Void> playerResult = playerService.dailyReset();
            XxlJobHelper.log("ç©å®¶é‡ç½®ç»“æœ: {}", playerResult.isSuccess() ? "æˆåŠŸ" : playerResult.getMessage());

            // 2. é‡ç½®å…¬ä¼šæ•°æ®
            XxlJobHelper.log("æ­¥éª¤ 2: é‡ç½®å…¬ä¼šæ¯æ—¥æ•°æ®...");
            Result<Void> guildResult = guildService.dailyReset();
            XxlJobHelper.log("å…¬ä¼šé‡ç½®ç»“æœ: {}", guildResult.isSuccess() ? "æˆåŠŸ" : guildResult.getMessage());

            // 3. å‘å¸ƒå…¨å±€äº‹ä»¶
            XxlJobHelper.log("æ­¥éª¤ 3: å‘å¸ƒæ¯æ—¥é‡ç½®äº‹ä»¶...");
            distributedEventBus.publishGlobal("daily:reset", today);

            long costTime = System.currentTimeMillis() - startTime;
            XxlJobHelper.log("æ¯æ—¥é‡ç½®ä»»åŠ¡å®Œæˆ, è€—æ—¶: {}ms", costTime);
            log.info("æ¯æ—¥é‡ç½®ä»»åŠ¡å®Œæˆ, date={}, è€—æ—¶={}ms", today, costTime);

        } catch (Exception e) {
            redisService.delete(lockKey);  // å¤±è´¥æ—¶åˆ é™¤é”ï¼Œå…è®¸é‡è¯•
            XxlJobHelper.log("æ¯æ—¥é‡ç½®ä»»åŠ¡å¼‚å¸¸: {}", e.getMessage());
            XxlJobHelper.handleFail("ä»»åŠ¡å¼‚å¸¸: " + e.getMessage());
            log.error("æ¯æ—¥é‡ç½®ä»»åŠ¡å¼‚å¸¸", e);
        }
    }
}
```

### 2. æ’è¡Œæ¦œå¿«ç…§ä»»åŠ¡

```java
package com.game.service.scheduler.job;

import com.game.api.rank.RankService;
import com.game.common.result.Result;
import com.xxl.job.core.context.XxlJobHelper;
import com.xxl.job.core.handler.annotation.XxlJob;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.dubbo.config.annotation.DubboReference;
import org.springframework.stereotype.Component;

/**
 * æ’è¡Œæ¦œä»»åŠ¡
 * <p>
 * å®šæœŸä¿å­˜æ’è¡Œæ¦œå¿«ç…§å’Œå‘æ”¾å¥–åŠ±
 * </p>
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class RankJob {

    @DubboReference(check = false)
    private RankService rankService;

    /**
     * æ¯å°æ—¶åˆ·æ–°æ’è¡Œæ¦œ
     * Cron: 0 0 * * * ?
     */
    @XxlJob("rankRefreshHandler")
    public void refreshRank() {
        XxlJobHelper.log("å¼€å§‹åˆ·æ–°æ’è¡Œæ¦œ...");
        
        try {
            Result<Void> result = rankService.refreshAll();
            if (result.isSuccess()) {
                XxlJobHelper.log("æ’è¡Œæ¦œåˆ·æ–°æˆåŠŸ");
            } else {
                XxlJobHelper.log("æ’è¡Œæ¦œåˆ·æ–°å¤±è´¥: {}", result.getMessage());
            }
        } catch (Exception e) {
            XxlJobHelper.handleFail("æ’è¡Œæ¦œåˆ·æ–°å¼‚å¸¸: " + e.getMessage());
            log.error("æ’è¡Œæ¦œåˆ·æ–°å¼‚å¸¸", e);
        }
    }

    /**
     * æ¯å‘¨ä¸€é›¶ç‚¹ä¿å­˜æ’è¡Œæ¦œå¿«ç…§å¹¶å‘å¥–
     * Cron: 0 0 0 ? * MON
     */
    @XxlJob("weeklyRankRewardHandler")
    public void weeklyRankReward() {
        XxlJobHelper.log("å¼€å§‹å¤„ç†å‘¨æ’è¡Œå¥–åŠ±...");
        
        try {
            // 1. ä¿å­˜å¿«ç…§
            XxlJobHelper.log("ä¿å­˜æ’è¡Œæ¦œå¿«ç…§...");
            rankService.saveSnapshot("COMBAT", "weekly");
            
            // 2. å‘æ”¾å¥–åŠ±
            XxlJobHelper.log("å‘æ”¾æ’è¡Œå¥–åŠ±...");
            rankService.sendRewards("COMBAT", "weekly");
            
            // 3. é‡ç½®æ’è¡Œæ¦œ
            XxlJobHelper.log("é‡ç½®å‘¨æ’è¡Œæ¦œ...");
            rankService.reset("COMBAT_WEEKLY");
            
            XxlJobHelper.log("å‘¨æ’è¡Œå¥–åŠ±å¤„ç†å®Œæˆ");
            
        } catch (Exception e) {
            XxlJobHelper.handleFail("å‘¨æ’è¡Œå¥–åŠ±å¤„ç†å¼‚å¸¸: " + e.getMessage());
            log.error("å‘¨æ’è¡Œå¥–åŠ±å¤„ç†å¼‚å¸¸", e);
        }
    }
}
```

### 3. æ´»åŠ¨ä»»åŠ¡

```java
package com.game.service.scheduler.job;

import com.game.data.redis.RedisService;
import com.xxl.job.core.context.XxlJobHelper;
import com.xxl.job.core.handler.annotation.XxlJob;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;

/**
 * æ´»åŠ¨ä»»åŠ¡
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class ActivityJob {

    private final RedisService redisService;

    /**
     * å¼€å¯æ´»åŠ¨
     * é€šè¿‡ XXL-Job åŠ¨æ€ä¼ å‚: {"activityId": 1001}
     */
    @XxlJob("activityStartHandler")
    public void startActivity() {
        // è·å–ä»»åŠ¡å‚æ•°
        String param = XxlJobHelper.getJobParam();
        XxlJobHelper.log("å¼€å¯æ´»åŠ¨ï¼Œå‚æ•°: {}", param);
        
        // è§£æå‚æ•°
        int activityId = parseActivityId(param);
        if (activityId <= 0) {
            XxlJobHelper.handleFail("æ— æ•ˆçš„æ´»åŠ¨ID");
            return;
        }
        
        // è®¾ç½®æ´»åŠ¨çŠ¶æ€
        String key = "activity:status:" + activityId;
        redisService.set(key, "RUNNING");
        
        XxlJobHelper.log("æ´»åŠ¨ {} å·²å¼€å¯", activityId);
    }

    /**
     * å…³é—­æ´»åŠ¨
     */
    @XxlJob("activityEndHandler")
    public void endActivity() {
        String param = XxlJobHelper.getJobParam();
        XxlJobHelper.log("å…³é—­æ´»åŠ¨ï¼Œå‚æ•°: {}", param);
        
        int activityId = parseActivityId(param);
        if (activityId <= 0) {
            XxlJobHelper.handleFail("æ— æ•ˆçš„æ´»åŠ¨ID");
            return;
        }
        
        // è®¾ç½®æ´»åŠ¨çŠ¶æ€
        String key = "activity:status:" + activityId;
        redisService.set(key, "ENDED");
        
        // ç»“ç®—æ´»åŠ¨å¥–åŠ±
        settleActivityRewards(activityId);
        
        XxlJobHelper.log("æ´»åŠ¨ {} å·²å…³é—­", activityId);
    }

    private int parseActivityId(String param) {
        try {
            // ç®€å•è§£æï¼Œå®é™…å¯ç”¨ JSON
            return Integer.parseInt(param.replaceAll("[^0-9]", ""));
        } catch (Exception e) {
            return 0;
        }
    }

    private void settleActivityRewards(int activityId) {
        // ç»“ç®—é€»è¾‘
    }
}
```

### 4. æ•°æ®æ¸…ç†ä»»åŠ¡

```java
package com.game.service.scheduler.job;

import com.xxl.job.core.context.XxlJobHelper;
import com.xxl.job.core.handler.annotation.XxlJob;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.data.mongodb.core.query.Query;
import org.springframework.stereotype.Component;

import java.time.Instant;
import java.time.temporal.ChronoUnit;

/**
 * æ•°æ®æ¸…ç†ä»»åŠ¡
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class CleanupJob {

    private final MongoTemplate mongoTemplate;

    /**
     * æ¸…ç†è¿‡æœŸæ—¥å¿— (æ¯å¤©å‡Œæ™¨3ç‚¹)
     * Cron: 0 0 3 * * ?
     */
    @XxlJob("cleanupLogsHandler")
    public void cleanupLogs() {
        XxlJobHelper.log("å¼€å§‹æ¸…ç†è¿‡æœŸæ—¥å¿—...");
        
        // æ¸…ç†30å¤©å‰çš„æ—¥å¿—
        long threshold = Instant.now().minus(30, ChronoUnit.DAYS).toEpochMilli();
        
        // æ¸…ç†æˆ˜æ–—æ—¥å¿—
        long combatDeleted = cleanCollection("combat_log", threshold);
        XxlJobHelper.log("æ¸…ç†æˆ˜æ–—æ—¥å¿—: {} æ¡", combatDeleted);
        
        // æ¸…ç†èŠå¤©æ—¥å¿—
        long chatDeleted = cleanCollection("chat_log", threshold);
        XxlJobHelper.log("æ¸…ç†èŠå¤©æ—¥å¿—: {} æ¡", chatDeleted);
        
        // æ¸…ç†ç™»å½•æ—¥å¿—
        long loginDeleted = cleanCollection("login_log", threshold);
        XxlJobHelper.log("æ¸…ç†ç™»å½•æ—¥å¿—: {} æ¡", loginDeleted);
        
        XxlJobHelper.log("æ—¥å¿—æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç† {} æ¡", 
                combatDeleted + chatDeleted + loginDeleted);
    }

    private long cleanCollection(String collection, long threshold) {
        Query query = new Query(Criteria.where("createTime").lt(threshold));
        return mongoTemplate.remove(query, collection).getDeletedCount();
    }
}
```

---

## ä»»åŠ¡å¼€å‘

### 1. ä»»åŠ¡å‚æ•°

```java
@XxlJob("paramJobHandler")
public void paramJob() {
    // è·å–ä»»åŠ¡å‚æ•°
    String param = XxlJobHelper.getJobParam();
    
    // JSON æ ¼å¼å‚æ•°è§£æ
    // {"type": "combat", "limit": 100}
    JsonNode node = JsonUtil.readTree(param);
    String type = node.get("type").asText();
    int limit = node.get("limit").asInt(10);
    
    XxlJobHelper.log("å‚æ•°: type={}, limit={}", type, limit);
}
```

### 2. ä»»åŠ¡æ—¥å¿—

```java
@XxlJob("logJobHandler")
public void logJob() {
    // å†™å…¥æ‰§è¡Œæ—¥å¿— (å¯åœ¨ XXL-Job Admin æŸ¥çœ‹)
    XxlJobHelper.log("å¼€å§‹æ‰§è¡Œä»»åŠ¡...");
    XxlJobHelper.log("å¤„ç†è¿›åº¦: {}/{}", current, total);
    XxlJobHelper.log("ä»»åŠ¡å®Œæˆ");
}
```

### 3. ä»»åŠ¡ç»“æœ

```java
@XxlJob("resultJobHandler")
public void resultJob() {
    try {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        doSomething();
        
        // æˆåŠŸ (é»˜è®¤)
        // æ— éœ€é¢å¤–å¤„ç†
        
    } catch (Exception e) {
        // å¤±è´¥
        XxlJobHelper.handleFail("ä»»åŠ¡å¤±è´¥: " + e.getMessage());
    }
}
```

### 4. ä»»åŠ¡è¶…æ—¶

```java
@XxlJob("timeoutJobHandler")
public void timeoutJob() {
    // ä»»åŠ¡è¶…æ—¶å¤„ç†
    // åœ¨ XXL-Job Admin é…ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´
    // è¶…æ—¶åä»»åŠ¡ä¼šè¢«ä¸­æ–­
    
    for (int i = 0; i < 1000; i++) {
        // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
        if (Thread.currentThread().isInterrupted()) {
            XxlJobHelper.log("ä»»åŠ¡è¢«ä¸­æ–­");
            return;
        }
        
        // å¤„ç†é€»è¾‘
        processItem(i);
    }
}
```

---

## é«˜çº§ç‰¹æ€§

### 1. ä»»åŠ¡åˆ†ç‰‡ (å¤§æ•°æ®é‡å¤„ç†)

```java
/**
 * åˆ†ç‰‡ä»»åŠ¡ç¤ºä¾‹
 * <p>
 * é€‚ç”¨äºå¤§æ•°æ®é‡å¤„ç†ï¼Œå¤šä¸ªæ‰§è¡Œå™¨å¹¶è¡Œå¤„ç†
 * </p>
 */
@XxlJob("shardingJobHandler")
public void shardingJob() {
    // è·å–åˆ†ç‰‡å‚æ•°
    int shardIndex = XxlJobHelper.getShardIndex();  // å½“å‰åˆ†ç‰‡ç´¢å¼•
    int shardTotal = XxlJobHelper.getShardTotal();  // æ€»åˆ†ç‰‡æ•°
    
    XxlJobHelper.log("åˆ†ç‰‡ä»»åŠ¡: å½“å‰åˆ†ç‰‡={}, æ€»åˆ†ç‰‡={}", shardIndex, shardTotal);
    
    // å‡è®¾éœ€è¦å¤„ç† 10000 ä¸ªç©å®¶
    // æ¯ä¸ªæ‰§è¡Œå™¨å¤„ç†è‡ªå·±åˆ†ç‰‡çš„æ•°æ®
    List<Long> allPlayerIds = getAllPlayerIds();
    
    for (int i = 0; i < allPlayerIds.size(); i++) {
        // åªå¤„ç†å±äºå½“å‰åˆ†ç‰‡çš„æ•°æ®
        if (i % shardTotal == shardIndex) {
            processPlayer(allPlayerIds.get(i));
        }
    }
    
    XxlJobHelper.log("åˆ†ç‰‡ {} å¤„ç†å®Œæˆ", shardIndex);
}
```

### 2. å¹¿æ’­ä»»åŠ¡ (æ‰€æœ‰æ‰§è¡Œå™¨éƒ½æ‰§è¡Œ)

```java
/**
 * å¹¿æ’­ä»»åŠ¡ç¤ºä¾‹
 * <p>
 * æ‰€æœ‰æ‰§è¡Œå™¨éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡
 * é€‚ç”¨äºï¼šæ¸…ç†æœ¬åœ°ç¼“å­˜ã€åŠ è½½é…ç½®ç­‰
 * </p>
 */
@XxlJob("broadcastJobHandler")
public void broadcastJob() {
    // è·¯ç”±ç­–ç•¥é€‰æ‹© "å¹¿æ’­" æ—¶ï¼Œæ‰€æœ‰æ‰§è¡Œå™¨éƒ½ä¼šæ‰§è¡Œ
    XxlJobHelper.log("å¹¿æ’­ä»»åŠ¡æ‰§è¡Œ - æ‰§è¡Œå™¨: {}", getExecutorId());
    
    // æ¸…ç†æœ¬åœ°ç¼“å­˜
    clearLocalCache();
    
    // é‡æ–°åŠ è½½é…ç½®
    reloadConfig();
}
```

### 3. é˜»å¡ç­–ç•¥

```java
/**
 * é˜»å¡ç­–ç•¥è¯´æ˜ï¼š
 * 1. å•æœºä¸²è¡Œ - å‰ä¸€æ¬¡ä»»åŠ¡æœªå®Œæˆï¼Œæ–°ä»»åŠ¡æ’é˜Ÿç­‰å¾…
 * 2. ä¸¢å¼ƒåç»­è°ƒåº¦ - å‰ä¸€æ¬¡ä»»åŠ¡æœªå®Œæˆï¼Œä¸¢å¼ƒæ–°ä»»åŠ¡
 * 3. è¦†ç›–ä¹‹å‰è°ƒåº¦ - ä¸­æ–­å‰ä¸€æ¬¡ä»»åŠ¡ï¼Œæ‰§è¡Œæ–°ä»»åŠ¡
 */
@XxlJob("blockingJobHandler")
public void blockingJob() {
    // é•¿æ—¶é—´æ‰§è¡Œçš„ä»»åŠ¡
    XxlJobHelper.log("å¼€å§‹æ‰§è¡Œé•¿ä»»åŠ¡...");
    
    for (int i = 0; i < 100; i++) {
        Thread.sleep(1000);
        XxlJobHelper.log("è¿›åº¦: {}/100", i + 1);
    }
    
    XxlJobHelper.log("é•¿ä»»åŠ¡å®Œæˆ");
}
```

### 4. å­ä»»åŠ¡è§¦å‘

```java
@XxlJob("parentJobHandler")
public void parentJob() {
    XxlJobHelper.log("çˆ¶ä»»åŠ¡å¼€å§‹...");
    
    // æ‰§è¡Œçˆ¶ä»»åŠ¡é€»è¾‘
    doParentWork();
    
    // åœ¨ XXL-Job Admin é…ç½®å­ä»»åŠ¡ID
    // çˆ¶ä»»åŠ¡å®Œæˆåè‡ªåŠ¨è§¦å‘å­ä»»åŠ¡
    
    XxlJobHelper.log("çˆ¶ä»»åŠ¡å®Œæˆï¼Œå­ä»»åŠ¡å°†è¢«è§¦å‘");
}

@XxlJob("childJobHandler")
public void childJob() {
    XxlJobHelper.log("å­ä»»åŠ¡å¼€å§‹...");
    
    // å­ä»»åŠ¡é€»è¾‘
    doChildWork();
    
    XxlJobHelper.log("å­ä»»åŠ¡å®Œæˆ");
}
```

---

## æœ€ä½³å®è·µ

### 1. é˜²é‡å¤æ‰§è¡Œ

```java
@XxlJob("idempotentJobHandler")
public void idempotentJob() {
    String today = LocalDate.now().toString();
    String lockKey = "job:lock:idempotent:" + today;
    
    // ä½¿ç”¨ Redis é˜²æ­¢é‡å¤æ‰§è¡Œ
    Boolean locked = redisService.setIfAbsent(lockKey, "1", Duration.ofHours(24));
    if (!Boolean.TRUE.equals(locked)) {
        XxlJobHelper.log("ä»»åŠ¡å·²æ‰§è¡Œè¿‡ï¼Œè·³è¿‡");
        return;
    }
    
    try {
        // æ‰§è¡Œä»»åŠ¡
        doWork();
    } catch (Exception e) {
        // å¤±è´¥æ—¶åˆ é™¤é”ï¼Œå…è®¸é‡è¯•
        redisService.delete(lockKey);
        throw e;
    }
}
```

### 2. ä»»åŠ¡ç›‘æ§

```java
@XxlJob("monitoredJobHandler")
public void monitoredJob() {
    long startTime = System.currentTimeMillis();
    int successCount = 0;
    int failCount = 0;
    
    try {
        List<Long> items = getItemsToProcess();
        XxlJobHelper.log("å¾…å¤„ç†æ•°é‡: {}", items.size());
        
        for (Long item : items) {
            try {
                processItem(item);
                successCount++;
            } catch (Exception e) {
                failCount++;
                log.error("å¤„ç†å¤±è´¥: item={}", item, e);
            }
            
            // å®šæœŸè¾“å‡ºè¿›åº¦
            if ((successCount + failCount) % 100 == 0) {
                XxlJobHelper.log("è¿›åº¦: {}/{}", successCount + failCount, items.size());
            }
        }
        
        long costTime = System.currentTimeMillis() - startTime;
        XxlJobHelper.log("ä»»åŠ¡å®Œæˆ: æˆåŠŸ={}, å¤±è´¥={}, è€—æ—¶={}ms", 
                successCount, failCount, costTime);
        
        // è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
        recordMetrics("monitoredJob", successCount, failCount, costTime);
        
    } catch (Exception e) {
        XxlJobHelper.handleFail("ä»»åŠ¡å¼‚å¸¸: " + e.getMessage());
        log.error("ä»»åŠ¡å¼‚å¸¸", e);
    }
}
```

### 3. ä»»åŠ¡é™çº§

```java
@XxlJob("degradableJobHandler")
public void degradableJob() {
    // æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
    if (isSystemOverloaded()) {
        XxlJobHelper.log("ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œä»»åŠ¡é™çº§");
        return;
    }
    
    // æ£€æŸ¥ä¾èµ–æœåŠ¡
    if (!isDependencyAvailable()) {
        XxlJobHelper.log("ä¾èµ–æœåŠ¡ä¸å¯ç”¨ï¼Œä»»åŠ¡è·³è¿‡");
        return;
    }
    
    // æ­£å¸¸æ‰§è¡Œ
    doWork();
}
```

---

## XXL-Job Admin é…ç½®

### 1. æ–°å¢ä»»åŠ¡

1. ç™»å½• XXL-Job Admin
2. ä»»åŠ¡ç®¡ç† -> æ–°å¢
3. é…ç½®å‚æ•°:
   - **æ‰§è¡Œå™¨**: é€‰æ‹© `game-scheduler`
   - **JobHandler**: å¡«å†™ `@XxlJob` çš„å€¼
   - **Cron**: å¡«å†™æ‰§è¡Œæ—¶é—´è¡¨è¾¾å¼
   - **è·¯ç”±ç­–ç•¥**: é€‰æ‹©åˆé€‚çš„ç­–ç•¥
   - **é˜»å¡å¤„ç†ç­–ç•¥**: é€‰æ‹©åˆé€‚çš„ç­–ç•¥

### 2. Cron è¡¨è¾¾å¼

| è¡¨è¾¾å¼ | è¯´æ˜ |
|-------|------|
| `0 0 0 * * ?` | æ¯å¤©é›¶ç‚¹ |
| `0 0 * * * ?` | æ¯å°æ—¶æ•´ç‚¹ |
| `0 */5 * * * ?` | æ¯5åˆ†é’Ÿ |
| `0 0 0 ? * MON` | æ¯å‘¨ä¸€é›¶ç‚¹ |
| `0 0 0 1 * ?` | æ¯æœˆ1å·é›¶ç‚¹ |
| `0 30 10 * * ?` | æ¯å¤©10:30 |

### 3. è·¯ç”±ç­–ç•¥

| ç­–ç•¥ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|-----|------|---------|
| ç¬¬ä¸€ä¸ª | å›ºå®šé€‰æ‹©ç¬¬ä¸€ä¸ªæ‰§è¡Œå™¨ | å•æœºä»»åŠ¡ |
| æœ€åä¸€ä¸ª | å›ºå®šé€‰æ‹©æœ€åä¸€ä¸ªæ‰§è¡Œå™¨ | å•æœºä»»åŠ¡ |
| è½®è¯¢ | ä¾æ¬¡é€‰æ‹©æ‰§è¡Œå™¨ | è´Ÿè½½å‡è¡¡ |
| éšæœº | éšæœºé€‰æ‹©æ‰§è¡Œå™¨ | è´Ÿè½½å‡è¡¡ |
| ä¸€è‡´æ€§HASH | æŒ‰å‚æ•°å“ˆå¸Œå›ºå®šæ‰§è¡Œå™¨ | ä¿è¯åŒå‚æ•°åŒæ‰§è¡Œå™¨ |
| åˆ†ç‰‡å¹¿æ’­ | æ‰€æœ‰æ‰§è¡Œå™¨å¹¶è¡Œæ‰§è¡Œ | å¤§æ•°æ®é‡å¹¶è¡Œå¤„ç† |
| å¹¿æ’­ | æ‰€æœ‰æ‰§è¡Œå™¨éƒ½æ‰§è¡Œ | é…ç½®åˆ·æ–°ã€ç¼“å­˜æ¸…ç† |
