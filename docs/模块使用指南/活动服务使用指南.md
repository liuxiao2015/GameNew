# 活动服务使用指南

## 概述

活动服务 (`service-activity`) 提供完整的游戏活动管理解决方案，支持多种活动类型：

| 类型 | 说明 | 示例 |
|------|------|------|
| 日常活动 | 每天固定时间开启 | 每日签到、每日副本 |
| 周期活动 | 按周期循环开启 | 周末活动、每周Boss |
| 限时活动 | 固定时间段开启 | 节日活动、运营活动 |
| 永久活动 | 常驻活动 | 累计充值、成就系统 |
| 开服活动 | 开服后一段时间内 | 7日登录、开服冲榜 |
| 节日活动 | 特定节日开启 | 春节、国庆 |

## 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                        活动服务架构                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   ActivityService                        │   │
│  │        (获取活动列表、详情、进度、领奖)                    │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│           ┌───────────────┼───────────────┐                     │
│           ▼               ▼               ▼                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │ Activity    │ │ Activity    │ │ Activity    │               │
│  │ Manager     │ │ Scheduler   │ │ Handler     │               │
│  │ (缓存管理)   │ │ (状态调度)   │ │ Factory     │               │
│  └─────────────┘ └─────────────┘ └──────┬──────┘               │
│                                         │                       │
│              ┌──────────────────────────┼──────────────────┐   │
│              ▼              ▼           ▼          ▼        │   │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────┐ ┌────────┐ │   │
│  │ SignIn       │ │ Accumulate   │ │ Rank     │ │Exchange│ │   │
│  │ Handler      │ │ Handler      │ │ Handler  │ │Handler │ │   │
│  │ (签到活动)    │ │ (累计活动)    │ │(排行活动) │ │(兑换)   │ │   │
│  └──────────────┘ └──────────────┘ └──────────┘ └────────┘ │   │
└─────────────────────────────────────────────────────────────────┘
```

## 活动状态流转

```
┌────────────┐
│ NOT_STARTED│ ─── 未开始
└─────┬──────┘
      │ 即将开始(30分钟内)
      ▼
┌────────────┐
│  PREVIEW   │ ─── 预告中
└─────┬──────┘
      │ 到达开始时间
      ▼
┌────────────┐
│  RUNNING   │ ─── 进行中
└─────┬──────┘
      │ 到达结束时间
      ▼
┌────────────┐
│   ENDED    │ ─── 已结束(可领奖)
└─────┬──────┘
      │ 领奖期结束
      ▼
┌────────────┐
│   CLOSED   │ ─── 已关闭
└────────────┘
```

## 快速开始

### 1. 获取活动列表

```java
@DubboReference
private ActivityService activityService;

public List<ActivityDTO> getActivityList(long roleId, int serverId) {
    Result<List<ActivityDTO>> result = activityService.getActivityList(roleId, serverId);
    return result.getData();
}
```

### 2. 获取活动详情

```java
public ActivityDetailDTO getActivityDetail(long roleId, int activityId) {
    Result<ActivityDetailDTO> result = activityService.getActivityDetail(roleId, activityId);
    return result.getData();
}
```

### 3. 参与活动 (如签到)

```java
public void signIn(long roleId, int activityId) {
    Result<Void> result = activityService.participate(roleId, activityId, "{}");
    if (result.isSuccess()) {
        // 签到成功
    }
}
```

### 4. 更新活动进度

```java
// 累计充值活动 - 充值时更新进度
public void onPaySuccess(long roleId, long amount) {
    activityService.updateProgress(roleId, RECHARGE_ACTIVITY_ID, "total_recharge", amount);
}
```

### 5. 领取奖励

```java
public List<RewardDTO> claimReward(long roleId, int activityId, String rewardId) {
    Result<List<RewardDTO>> result = activityService.claimReward(roleId, activityId, rewardId);
    return result.getData();
}
```

## 活动配置

### 活动配置表结构

```javascript
// MongoDB: activity_config
{
    "activityId": 1001,
    "name": "每日签到",
    "description": "每日签到领取丰厚奖励",
    "type": 1,           // DAILY
    "status": 2,         // RUNNING
    "resetType": 1,      // 每日重置
    "templateId": "sign_in",  // 处理器模板ID
    "version": 1,
    
    // 时间配置
    "startTime": "2024-01-01T00:00:00",
    "endTime": "2024-12-31T23:59:59",
    "dailyStartTime": "00:00:00",
    "dailyEndTime": "23:59:59",
    
    // 条件配置
    "minLevel": 10,
    "maxLevel": 0,       // 0=不限
    "vipRequired": 0,
    "serverIds": [],     // 空=全服
    
    // 奖励配置
    "goalsJson": "[{\"goalId\":\"cumulative_sign\",\"name\":\"累计签到\",\"targetValue\":30}]",
    "rewardsJson": "[{\"rewardId\":\"day1\",\"goalId\":\"cumulative_sign\",\"requiredProgress\":1,\"rewards\":[{\"type\":2,\"itemId\":10001,\"count\":100}]}]",
    
    // 显示配置
    "icon": "activity_sign.png",
    "sortOrder": 1,
    "showOnMain": true,
    "showRedDot": true,
    "tags": ["每日", "推荐"]
}
```

### 奖励配置格式

```json
[
    {
        "rewardId": "reward_1",
        "name": "累计签到1天奖励",
        "goalId": "cumulative_sign",
        "requiredProgress": 1,
        "rewards": [
            {"type": 1, "itemId": 1, "count": 10000},
            {"type": 2, "itemId": 10001, "count": 10}
        ]
    },
    {
        "rewardId": "reward_7",
        "name": "累计签到7天奖励",
        "goalId": "cumulative_sign",
        "requiredProgress": 7,
        "rewards": [
            {"type": 2, "itemId": 10002, "count": 1}
        ]
    }
]
```

## 自定义活动处理器

### 实现步骤

1. 继承 `AbstractActivityHandler`
2. 实现 `getTemplateId()` 返回唯一模板ID
3. 实现核心方法

```java
@Slf4j
@Component
public class MyActivityHandler extends AbstractActivityHandler {

    @Override
    public String getTemplateId() {
        return "my_activity";  // 与配置中的 templateId 对应
    }

    @Override
    public void onPlayerInit(ActivityConfig config, PlayerActivity playerActivity) {
        // 初始化玩家数据
        playerActivity.setProgress("main_goal", 0);
    }

    @Override
    public boolean participate(ActivityConfig config, PlayerActivity playerActivity, 
                                Map<String, Object> params) {
        // 参与活动逻辑
        playerActivity.addProgress("main_goal", 1);
        return true;
    }

    @Override
    public void onDailyReset(ActivityConfig config, PlayerActivity playerActivity) {
        // 每日重置逻辑
        playerActivity.setProgress("daily_goal", 0);
    }
}
```

## 内置活动处理器

| 模板ID | 处理器 | 说明 |
|--------|--------|------|
| `sign_in` | SignInActivityHandler | 签到活动 |
| `accumulate` | AccumulateActivityHandler | 累计活动 |
| `rank` | RankActivityHandler | 排行冲榜活动 |
| `exchange` | ExchangeActivityHandler | 兑换活动 |

## 活动事件

```java
// 监听活动开始
@EventListener
public void onActivityStart(ActivityEvents.ActivityStartEvent event) {
    log.info("活动开始: activityId={}", event.getActivityId());
    // 发送全服公告
}

// 监听进度更新
@EventListener
public void onProgressUpdate(ActivityEvents.ProgressUpdateEvent event) {
    log.info("进度更新: roleId={}, goal={}, {}->{}",
        event.getRoleId(), event.getGoalId(), 
        event.getOldProgress(), event.getNewProgress());
}

// 监听奖励领取
@EventListener
public void onRewardClaimed(ActivityEvents.RewardClaimedEvent event) {
    log.info("领取奖励: roleId={}, rewardId={}", 
        event.getRoleId(), event.getRewardId());
}
```

## 与其他系统集成

### 充值触发活动进度

```java
// 在支付服务中
@EventListener
public void onPaySuccess(PayEvents.PaySuccessEvent event) {
    // 更新累计充值活动
    activityService.updateProgress(
        event.getRoleId(), 
        ACCUMULATE_RECHARGE_ACTIVITY_ID, 
        "total_recharge", 
        event.getAmount().longValue()
    );
}
```

### 登录触发签到

```java
// 在登录服务中
public void onPlayerLogin(long roleId) {
    // 自动弹出签到界面或检查今日是否已签到
    Result<PlayerActivityDTO> result = activityService.getPlayerProgress(
        roleId, DAILY_SIGN_ACTIVITY_ID);
    
    if (result.isSuccess() && result.getData().getTodayCount() == 0) {
        // 提示用户签到
    }
}
```

## 常见问题

### Q: 如何添加新的活动类型？
1. 在 `ActivityType` 枚举中添加新类型
2. 创建对应的 `ActivityHandler` 处理器
3. 在数据库中配置活动

### Q: 活动数据如何重置？
- 每日重置：调度器每日凌晨自动调用 `onDailyReset`
- 活动周期重置：新版本活动开始时自动创建新数据

### Q: 如何处理跨服活动？
配置 `serverIds` 为空即表示全服活动，排行榜数据会汇总。
