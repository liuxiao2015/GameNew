# 游戏服务器框架架构设计文档

> **版本**: v3.1  
> **更新日期**: 2026-02

---

## 1. 整体架构

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           客户端 (Client)                                │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │ TCP/WebSocket
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         网关层 (Gateway Layer)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                      │
│  │  Gateway-1  │  │  Gateway-2  │  │  Gateway-N  │                      │
│  │  (Netty)    │  │  (Netty)    │  │  (Netty)    │                      │
│  └─────────────┘  └─────────────┘  └─────────────┘                      │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │ Dubbo RPC
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         服务层 (Service Layer)                           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │  Login   │ │   Game   │ │  Guild   │ │   Chat   │ │   Rank   │      │
│  │ Service  │ │ Service  │ │ Service  │ │ Service  │ │ Service  │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│  ┌──────────┐ ┌──────────┐                                              │
│  │Scheduler │ │   GM     │                                              │
│  │ Service  │ │ Service  │                                              │
│  └──────────┘ └──────────┘                                              │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         数据层 (Data Layer)                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │     MongoDB      │  │      Redis       │  │      Nacos       │      │
│  │   (持久化存储)    │  │  (缓存/排行榜)    │  │  (配置/注册中心)  │      │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈

| 层次 | 技术 | 说明 |
|-----|------|------|
| **语言** | Java 21 | LTS 版本，Virtual Threads 支持 |
| **框架** | Spring Boot 3.3 | 核心框架 |
| **网络通信** | Netty | 高性能网络框架 |
| **序列化** | Protobuf | 高效二进制序列化 |
| **RPC** | Dubbo 3.2 | 微服务间通信 |
| **注册中心** | Nacos | 服务注册与发现、配置管理 |
| **持久化** | MongoDB | 文档数据库 |
| **缓存** | Redis | 缓存、排行榜、分布式锁 |
| **消息队列** | RabbitMQ | 聊天、分布式事件 |
| **任务调度** | XXL-Job | 分布式任务调度 |
| **日志聚合** | Loki + Grafana | 集中日志管理 |
| **API文档** | SpringDoc OpenAPI | Swagger UI |
| **容器化** | Docker Compose | 本地开发环境 |

---

## 2. 模块设计

### 2.1 模块结构

```
game-server/
├── common/                      # 通用模块
│   ├── common-api/              # API定义 (Dubbo接口、DTO)
│   ├── common-entity/           # MongoDB实体和Repository
│   └── common-config/           # 游戏配置表
│
├── framework/                   # 框架模块
│   ├── framework-common/        # 公共工具类
│   ├── framework-core/          # 核心框架 (协议分发、事件总线)
│   ├── framework-actor/         # Actor并发模型
│   ├── framework-data/          # 数据访问 (MongoDB、Redis)
│   ├── framework-log/           # 日志模块
│   └── framework-mq/            # 消息队列 (RabbitMQ)
│
├── services/                    # 微服务 (所有可启动的服务)
│   ├── service-gateway/         # 网关服务 (Netty)
│   ├── service-login/           # 登录服务
│   ├── service-game/            # 游戏服务
│   ├── service-guild/           # 公会服务
│   ├── service-chat/            # 聊天服务
│   ├── service-rank/            # 排行榜服务
│   ├── service-scheduler/       # 定时任务服务
│   ├── service-activity/        # 活动服务
│   ├── service-pay/             # 支付服务
│   ├── service-battle/          # 战斗服务
│   ├── service-robot/           # 机器人服务
│   └── service-gm/              # GM后台服务
│
├── launcher/                    # 服务启动器 (独立于被管理的服务)
│   └── src/                     # 一键启动/停止/管理所有服务
│
├── docker/                      # Docker配置
│   ├── docker-compose.yml       # 基础设施 (Nacos、MongoDB、Redis等)
│   ├── loki/                    # Loki日志配置
│   └── grafana/                 # Grafana监控配置
│
├── config/                      # 配置文件
│   └── nacos/                   # Nacos配置
│
├── scripts/                     # 脚本
│   ├── start-services.ps1       # Windows启动脚本
│   └── start-services.sh        # Linux启动脚本
│
└── launcher.yaml                # 启动器配置文件
```

### 2.2 模块职责

| 模块 | 职责 |
|-----|------|
| **common-api** | Dubbo 服务接口、DTO 定义 |
| **common-entity** | MongoDB 实体类和 Repository |
| **common-config** | 游戏配置表加载和热更新 |
| **framework-common** | 公共工具类、Result封装、常量定义 |
| **framework-core** | 核心框架：协议分发、事件总线、Session管理 |
| **framework-actor** | Actor 并发模型 (Java 21 Virtual Threads) |
| **framework-data** | MongoDB 和 Redis 数据访问封装 |
| **framework-log** | 操作日志、审计日志 |
| **framework-mq** | RabbitMQ 消息队列封装 |
| **service-gateway** | 客户端连接、协议转发、消息推送 |
| **service-login** | 账号登录、角色创建、服务器列表 |
| **service-game** | 玩家数据、背包、任务等核心玩法 |
| **service-guild** | 公会系统 |
| **service-chat** | 聊天系统 (使用 RabbitMQ) |
| **service-rank** | 排行榜系统 (Redis ZSet) |
| **service-scheduler** | 定时任务调度 (XXL-Job) |
| **service-activity** | 活动系统 |
| **service-pay** | 支付系统 |
| **service-battle** | 战斗系统 |
| **service-gm** | GM 后台和热更新 (带 Swagger API 文档) |
| **launcher** | 服务启动器：一键启停、Docker管理、基础设施检查 |

---

## 3. 核心设计

### 3.1 Actor 模型

```
┌─────────────────────────────────────────────────────────────┐
│                     ActorSystem                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                   Actor Cache (Caffeine)                ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                 ││
│  │  │ Actor 1 │  │ Actor 2 │  │ Actor N │                 ││
│  │  │ mailbox │  │ mailbox │  │ mailbox │                 ││
│  │  └────┬────┘  └────┬────┘  └────┬────┘                 ││
│  └───────│────────────│────────────│───────────────────────┘│
│          └────────────┼────────────┘                        │
│                       ▼                                     │
│          Virtual Thread Executor                            │
└─────────────────────────────────────────────────────────────┘
```

**特点**:
- 每个实体（玩家/公会）对应一个 Actor
- 内部单线程处理，无需加锁
- 通过消息队列实现线程安全
- 自动定期保存脏数据
- 空闲自动淘汰

### 3.2 协议分发

```
Client Request
      │
      ▼
┌─────────────┐
│   Gateway   │ ─── 解析协议ID
└──────┬──────┘
       │ Dubbo RPC
       ▼
┌─────────────┐
│   Service   │ ─── 根据 @Protocol 注解路由
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Handler   │ ─── 业务处理
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Response   │ ─── 返回客户端
└─────────────┘
```

### 3.3 事件驱动

```
事件发布者                    EventBus                    事件监听者
    │                            │                            │
    │  publish(event)            │                            │
    │ ────────────────────────>  │                            │
    │                            │   invoke listeners         │
    │                            │ ────────────────────────>  │
    │                            │                            │
    │                            │   (async listeners)        │
    │                            │ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>  │
```

---

## 4. 数据设计

### 4.1 数据存储策略

| 数据类型 | 存储位置 | 说明 |
|---------|---------|------|
| 玩家核心数据 | MongoDB | 持久化存储 |
| 公会数据 | MongoDB | 持久化存储 |
| 在线状态 | Redis | 快速查询 |
| 排行榜 | Redis ZSet | 实时排名 |
| 会话信息 | Redis | 过期自动清理 |
| 分布式锁 | Redis | 互斥控制 |
| 配置数据 | JSON/Nacos | 热更新 |

### 4.2 缓存策略

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Request   │ ──> │ L1 Caffeine │ ──> │  L2 Redis   │
└─────────────┘     └─────────────┘     └─────────────┘
                          │                    │
                          │ miss               │ miss
                          ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │    Redis    │     │   MongoDB   │
                    └─────────────┘     └─────────────┘
```

---

## 5. 通信设计

### 5.1 协议格式

```
┌──────────────────────────────────────────────────┐
│  Header (12 bytes)                               │
├────────────┬────────────┬────────────┬──────────┤
│  Length    │ ProtocolId │  Reserved  │   CRC    │
│  (4 bytes) │ (4 bytes)  │  (2 bytes) │ (2bytes) │
├────────────┴────────────┴────────────┴──────────┤
│  Body (Protobuf encoded)                        │
│  ............................................   │
└──────────────────────────────────────────────────┘
```

### 5.2 服务调用

```
Game Service                    Guild Service
     │                               │
     │  @DubboReference              │  @DubboService
     │  guildService                 │  GuildServiceImpl
     │                               │
     │   createGuild(roleId, name)   │
     │ ────────────────────────────> │
     │                               │
     │   Result<GuildDTO>            │
     │ <──────────────────────────── │
```

---

## 6. 部署架构

### 6.1 单机部署

```
┌─────────────────────────────────────┐
│            Single Server            │
│  ┌─────────┐  ┌─────────────────┐  │
│  │ Gateway │  │ All Services    │  │
│  └─────────┘  └─────────────────┘  │
│  ┌─────────┐  ┌─────────┐          │
│  │ MongoDB │  │  Redis  │          │
│  └─────────┘  └─────────┘          │
└─────────────────────────────────────┘
```

### 6.2 集群部署

```
                    ┌─────────────┐
                    │   Nginx/LB  │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│   Gateway-1   │  │   Gateway-2   │  │   Gateway-N   │
└───────┬───────┘  └───────┬───────┘  └───────┬───────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │ Dubbo
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│  Service-1    │  │  Service-2    │  │  Service-N    │
└───────────────┘  └───────────────┘  └───────────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ MongoDB(主从) │  │ Redis(集群)   │  │    Nacos      │
└───────────────┘  └───────────────┘  └───────────────┘
```

---

## 7. 扩展性设计

### 7.1 水平扩展

- **Gateway**: 无状态，可任意扩展
- **Service**: 使用一致性哈希路由，保证同一玩家/公会请求到同一实例
- **MongoDB**: 分片集群
- **Redis**: Cluster 模式

### 7.2 垂直拆分

根据业务量可以将服务进一步拆分：
- 玩家服务拆分：基础服务、背包服务、任务服务
- 公会服务拆分：基础服务、公会战服务

---

## 8. 安全设计

### 8.1 通信安全

- 协议加密：AES 对称加密
- 签名验证：HMAC-SHA256
- 防重放：时间戳 + nonce

### 8.2 业务安全

- IP 黑名单
- 敏感词过滤
- 频率限制
- 参数校验

---

## 9. 监控告警

### 9.1 监控指标

- QPS / TPS
- 响应时间 (P99, P95, AVG)
- 错误率
- 在线人数
- JVM 指标
- 数据库连接数

### 9.2 告警规则

- 响应时间 > 1s
- 错误率 > 1%
- CPU > 80%
- 内存 > 90%
- 服务下线

---

## 10. 快速入门

### 10.1 环境要求

- Java 21+
- Maven 3.9+
- Docker Desktop

### 10.2 一键启动

```bash
# 1. 构建项目
mvn clean package -DskipTests

# 2. 一键启动 (Windows)
.\scripts\start-services.ps1 up

# 2. 一键启动 (Linux/Mac)
./scripts/start-services.sh up
```

### 10.3 启动器命令

```bash
# 交互模式
java -jar launcher/target/launcher-1.0.0-SNAPSHOT.jar

# 可用命令
launcher> up                    # 一键启动 (Docker + 所有服务)
launcher> down                  # 停止所有服务
launcher> status                # 查看服务状态
launcher> list                  # 列出所有服务
launcher> start service-game    # 启动指定服务
launcher> stop service-chat     # 停止指定服务
launcher> restart all           # 重启所有服务
launcher> docker status         # 查看 Docker 容器状态
launcher> check                 # 检查基础设施状态
launcher> refresh               # 刷新/发现新服务
launcher> help                  # 显示帮助
launcher> exit                  # 退出
```

### 10.4 访问地址

| 服务 | 地址 |
|------|------|
| Nacos 控制台 | http://localhost:8848/nacos |
| Grafana 监控 | http://localhost:3000 |
| GM 后台 Swagger | http://localhost:8090/swagger-ui.html |
| RabbitMQ 管理 | http://localhost:15672 |
| XXL-Job 管理 | http://localhost:8088/xxl-job-admin |

### 10.5 新增服务

1. 在 `services/` 目录创建新服务模块
2. 添加 `pom.xml` 和 `application.yml`
3. 在根 `pom.xml` 添加 `<module>`
4. 执行 `launcher> refresh` 自动发现新服务
