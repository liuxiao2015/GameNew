# 游戏服务器框架架构设计文档

> **版本**: v3.0  
> **更新日期**: 2026-01

---

## 1. 整体架构

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           客户端 (Client)                                │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │ TCP/WebSocket
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         网关层 (Gateway Layer)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                      │
│  │  Gateway-1  │  │  Gateway-2  │  │  Gateway-N  │                      │
│  │  (Netty)    │  │  (Netty)    │  │  (Netty)    │                      │
│  └─────────────┘  └─────────────┘  └─────────────┘                      │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │ Dubbo RPC
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         服务层 (Service Layer)                           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │  Login   │ │   Game   │ │  Guild   │ │   Chat   │ │   Rank   │      │
│  │ Service  │ │ Service  │ │ Service  │ │ Service  │ │ Service  │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
│  ┌──────────┐ ┌──────────┐                                              │
│  │Scheduler │ │   GM     │                                              │
│  │ Service  │ │ Service  │                                              │
│  └──────────┘ └──────────┘                                              │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         数据层 (Data Layer)                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │     MongoDB      │  │      Redis       │  │      Nacos       │      │
│  │   (持久化存储)    │  │  (缓存/排行榜)    │  │  (配置/注册中心)  │      │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈

| 层次 | 技术 | 说明 |
|-----|------|------|
| 网络通信 | Netty | 高性能网络框架 |
| 序列化 | Protobuf | 高效二进制序列化 |
| RPC | Dubbo | 微服务间通信 |
| 注册中心 | Nacos | 服务注册与发现 |
| 持久化 | MongoDB | 文档数据库 |
| 缓存 | Redis | 缓存、排行榜、分布式锁 |
| 任务调度 | XXL-Job | 分布式任务调度 |
| 容器化 | Docker/K8s | 容器编排 |

---

## 2. 模块设计

### 2.1 模块结构

```
game-server/
├── common/                      # 通用模块
│   ├── common-api/              # API定义 (接口、DTO、Proto)
│   └── common-config/           # 游戏配置
│
├── framework/                   # 框架模块
│   ├── framework-core/          # 核心框架
│   ├── framework-actor/         # Actor模型
│   └── framework-data/          # 数据访问
│
├── gateway/                     # 网关模块
│   └── gateway-server/          # 网关服务
│
├── services/                    # 业务服务
│   ├── service-login/           # 登录服务
│   ├── service-game/            # 游戏服务
│   ├── service-guild/           # 公会服务
│   ├── service-chat/            # 聊天服务
│   ├── service-rank/            # 排行服务
│   └── service-scheduler/       # 调度服务
│
└── support/                     # 支撑模块
    └── support-gm/              # GM工具
```

### 2.2 模块职责

| 模块 | 职责 |
|-----|------|
| common-api | 定义服务接口、DTO、Protobuf 协议 |
| common-config | 游戏配置表加载和管理 |
| framework-core | 核心框架：协议分发、事件总线、Session管理 |
| framework-actor | Actor 并发模型实现 |
| framework-data | MongoDB 和 Redis 数据访问封装 |
| gateway-server | 客户端连接、协议转发、消息推送 |
| service-login | 账号登录、角色创建、服务器列表 |
| service-game | 玩家数据、背包、任务等核心玩法 |
| service-guild | 公会系统 |
| service-chat | 聊天系统 |
| service-rank | 排行榜系统 |
| service-scheduler | 定时任务调度 |
| support-gm | GM 工具和热更新 |

---

## 3. 核心设计

### 3.1 Actor 模型

```
┌─────────────────────────────────────────────────────────────┐
│                     ActorSystem                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                   Actor Cache (Caffeine)                ││
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                 ││
│  │  │ Actor 1 │  │ Actor 2 │  │ Actor N │                 ││
│  │  │ mailbox │  │ mailbox │  │ mailbox │                 ││
│  │  └────┬────┘  └────┬────┘  └────┬────┘                 ││
│  └───────│────────────│────────────│───────────────────────┘│
│          └────────────┼────────────┘                        │
│                       ▼                                     │
│          Virtual Thread Executor                            │
└─────────────────────────────────────────────────────────────┘
```

**特点**:
- 每个实体（玩家/公会）对应一个 Actor
- 内部单线程处理，无需加锁
- 通过消息队列实现线程安全
- 自动定期保存脏数据
- 空闲自动淘汰

### 3.2 协议分发

```
Client Request
      │
      ▼
┌─────────────┐
│   Gateway   │ ─── 解析协议ID
└──────┬──────┘
       │ Dubbo RPC
       ▼
┌─────────────┐
│   Service   │ ─── 根据 @Protocol 注解路由
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Handler   │ ─── 业务处理
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Response   │ ─── 返回客户端
└─────────────┘
```

### 3.3 事件驱动

```
事件发布者                    EventBus                    事件监听者
    │                            │                            │
    │  publish(event)            │                            │
    │ ────────────────────────>  │                            │
    │                            │   invoke listeners         │
    │                            │ ────────────────────────>  │
    │                            │                            │
    │                            │   (async listeners)        │
    │                            │ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─>  │
```

---

## 4. 数据设计

### 4.1 数据存储策略

| 数据类型 | 存储位置 | 说明 |
|---------|---------|------|
| 玩家核心数据 | MongoDB | 持久化存储 |
| 公会数据 | MongoDB | 持久化存储 |
| 在线状态 | Redis | 快速查询 |
| 排行榜 | Redis ZSet | 实时排名 |
| 会话信息 | Redis | 过期自动清理 |
| 分布式锁 | Redis | 互斥控制 |
| 配置数据 | JSON/Nacos | 热更新 |

### 4.2 缓存策略

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Request   │ ──> │ L1 Caffeine │ ──> │  L2 Redis   │
└─────────────┘     └─────────────┘     └─────────────┘
                          │                    │
                          │ miss               │ miss
                          ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │    Redis    │     │   MongoDB   │
                    └─────────────┘     └─────────────┘
```

---

## 5. 通信设计

### 5.1 协议格式

```
┌──────────────────────────────────────────────────┐
│  Header (12 bytes)                               │
├────────────┬────────────┬────────────┬──────────┤
│  Length    │ ProtocolId │  Reserved  │   CRC    │
│  (4 bytes) │ (4 bytes)  │  (2 bytes) │ (2bytes) │
├────────────┴────────────┴────────────┴──────────┤
│  Body (Protobuf encoded)                        │
│  ............................................   │
└──────────────────────────────────────────────────┘
```

### 5.2 服务调用

```
Game Service                    Guild Service
     │                               │
     │  @DubboReference              │  @DubboService
     │  guildService                 │  GuildServiceImpl
     │                               │
     │   createGuild(roleId, name)   │
     │ ────────────────────────────> │
     │                               │
     │   Result<GuildDTO>            │
     │ <──────────────────────────── │
```

---

## 6. 部署架构

### 6.1 单机部署

```
┌─────────────────────────────────────┐
│            Single Server            │
│  ┌─────────┐  ┌─────────────────┐  │
│  │ Gateway │  │ All Services    │  │
│  └─────────┘  └─────────────────┘  │
│  ┌─────────┐  ┌─────────┐          │
│  │ MongoDB │  │  Redis  │          │
│  └─────────┘  └─────────┘          │
└─────────────────────────────────────┘
```

### 6.2 集群部署

```
                    ┌─────────────┐
                    │   Nginx/LB  │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│   Gateway-1   │  │   Gateway-2   │  │   Gateway-N   │
└───────┬───────┘  └───────┬───────┘  └───────┬───────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │ Dubbo
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│  Service-1    │  │  Service-2    │  │  Service-N    │
└───────────────┘  └───────────────┘  └───────────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ MongoDB(主从) │  │ Redis(集群)   │  │    Nacos      │
└───────────────┘  └───────────────┘  └───────────────┘
```

---

## 7. 扩展性设计

### 7.1 水平扩展

- **Gateway**: 无状态，可任意扩展
- **Service**: 使用一致性哈希路由，保证同一玩家/公会请求到同一实例
- **MongoDB**: 分片集群
- **Redis**: Cluster 模式

### 7.2 垂直拆分

根据业务量可以将服务进一步拆分：
- 玩家服务拆分：基础服务、背包服务、任务服务
- 公会服务拆分：基础服务、公会战服务

---

## 8. 安全设计

### 8.1 通信安全

- 协议加密：AES 对称加密
- 签名验证：HMAC-SHA256
- 防重放：时间戳 + nonce

### 8.2 业务安全

- IP 黑名单
- 敏感词过滤
- 频率限制
- 参数校验

---

## 9. 监控告警

### 9.1 监控指标

- QPS / TPS
- 响应时间 (P99, P95, AVG)
- 错误率
- 在线人数
- JVM 指标
- 数据库连接数

### 9.2 告警规则

- 响应时间 > 1s
- 错误率 > 1%
- CPU > 80%
- 内存 > 90%
- 服务下线
