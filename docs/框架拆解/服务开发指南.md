# 服务开发指南

本文档为各服务模块提供开发指南和最佳实践。

---

## 目录

1. [通用开发规范](#一通用开发规范)
2. [service-game 游戏服务](#二service-game-游戏服务)
3. [service-guild 公会服务](#三service-guild-公会服务)
4. [service-chat 聊天服务](#四service-chat-聊天服务)
5. [service-rank 排行服务](#五service-rank-排行服务)
6. [service-scheduler 调度服务](#六service-scheduler-调度服务)

---

## 一、通用开发规范

### 1.1 Handler 开发

```java
@ProtocolController(moduleId = 0x02, value = "玩家模块")
@RequiredArgsConstructor
public class PlayerHandler extends BaseHandler {
    
    private final PlayerActorSystem playerActorSystem;
    private final DubboPushService pushService;
    
    @Protocol(methodId = MethodId.Player.GET_INFO, desc = "获取玩家信息")
    public Message getPlayerInfo(Session session, C2S_GetPlayerInfo request) {
        PlayerActor actor = playerActorSystem.getOrCreate(session.getRoleId());
        
        return S2C_GetPlayerInfo.newBuilder()
            .setResult(buildSuccessResult())
            .setPlayer(actor.buildPlayerInfo())
            .build();
    }
}
```

### 1.2 Service 开发

```java
@Service
@RequiredArgsConstructor
public class PlayerService extends BaseService {
    
    private final PlayerRepository playerRepository;
    private final EventBus eventBus;
    
    public void addGold(long roleId, int amount) {
        checkPositive(amount, ErrorCode.PARAM_ERROR);
        
        PlayerData player = playerRepository.findById(roleId);
        checkNotNull(player, ErrorCode.ROLE_NOT_FOUND);
        
        player.setGold(player.getGold() + amount);
        playerRepository.save(player);
        
        // 发布事件
        eventBus.publish(new PlayerGoldChangeEvent(roleId, amount));
        
        // 推送给客户端
        pushGoldChange(roleId, player.getGold());
    }
}
```

### 1.3 事件监听

```java
@Component
@RequiredArgsConstructor
public class GameEventListener {
    
    private final RewardService rewardService;
    
    @EventListener
    public void onLevelUp(PlayerLevelUpEvent event) {
        rewardService.sendLevelUpReward(event.getRoleId(), event.getNewLevel());
    }
    
    @EventListener
    public void onGuildJoin(GuildJoinEvent event) {
        log.info("玩家加入公会: roleId={}, guildId={}", 
                event.getRoleId(), event.getGuildId());
    }
}
```

---

## 二、service-game 游戏服务

### 2.1 职责

- 玩家数据管理
- 背包/道具/装备
- 任务系统
- 成就系统
- 活动系统

### 2.2 核心组件

| 组件 | 说明 |
|-----|------|
| PlayerActorSystem | 玩家 Actor 系统 |
| PlayerActor | 玩家状态管理 |
| BagService | 背包服务 |
| TaskService | 任务服务 |

### 2.3 示例：背包操作

```java
@Service
@RequiredArgsConstructor
public class BagService {
    
    private final ItemConfigContainer itemConfig;
    
    public boolean addItem(PlayerActor actor, int itemId, int count) {
        ItemConfig config = itemConfig.getOrThrow(itemId);
        
        // 检查背包空间
        if (!actor.getBag().hasSpace(config, count)) {
            return false;
        }
        
        // 添加道具
        actor.getBag().addItem(itemId, count);
        
        // 推送变更
        pushBagChange(actor.getRoleId(), itemId, count);
        
        return true;
    }
}
```

---

## 三、service-guild 公会服务

### 3.1 职责

- 公会创建/解散
- 成员管理
- 公会战
- 公会任务

### 3.2 核心组件

| 组件 | 说明 |
|-----|------|
| GuildActorSystem | 公会 Actor 系统 |
| GuildActor | 公会状态管理 |
| GuildBusinessService | 公会业务逻辑 |

### 3.3 示例：公会捐献

```java
@Service
@RequiredArgsConstructor
public class GuildBusinessService {
    
    @DubboReference
    private PlayerService playerService;
    
    private final GuildActorSystem guildActorSystem;
    private final DubboPushService pushService;
    private final SagaService sagaService;
    
    public Result<Void> donate(long roleId, long guildId, int amount) {
        // 使用 Saga 保证一致性
        SagaResult result = sagaService.begin()
            .name("公会捐献")
            .step("扣除金币",
                () -> playerService.deductGold(roleId, amount).isSuccess(),
                () -> playerService.addGold(roleId, amount))
            .step("增加公会资金",
                () -> addGuildFund(guildId, amount),
                () -> deductGuildFund(guildId, amount))
            .execute();
        
        if (!result.isSuccess()) {
            return Result.fail(ErrorCode.SYSTEM_ERROR);
        }
        
        // 广播给公会成员
        pushService.pushToGuildExclude(guildId, roleId, 
            MethodId.Push.GUILD_NOTICE, buildDonateNotice(roleId, amount));
        
        return Result.success();
    }
}
```

---

## 四、service-chat 聊天服务

### 4.1 职责

- 聊天频道管理
- 消息存储
- 敏感词过滤
- 聊天记录

### 4.2 核心组件

| 组件 | 说明 |
|-----|------|
| ChatBusinessService | 聊天业务逻辑 |
| ChatHandler | 聊天协议处理 |
| ChatEventListener | 玩家上下线监听 |

### 4.3 示例：发送聊天消息

```java
@Service
@RequiredArgsConstructor
public class ChatBusinessService {
    
    private final SecurityFilter securityFilter;
    private final DubboPushService pushService;
    private final ChatMessageRepository messageRepository;
    
    public Result<Void> sendMessage(long roleId, int channel, String content) {
        // 敏感词过滤
        String filteredContent = securityFilter.filterSensitiveWords(content);
        
        // 保存消息
        ChatMessage message = new ChatMessage();
        message.setRoleId(roleId);
        message.setChannel(channel);
        message.setContent(filteredContent);
        message.setCreateTime(LocalDateTime.now());
        messageRepository.save(message);
        
        // 推送消息
        switch (channel) {
            case ChatChannel.WORLD -> pushService.broadcast(
                MethodId.Push.CHAT_MESSAGE, buildChatPush(message));
            case ChatChannel.GUILD -> pushService.pushToGuild(
                getGuildId(roleId), MethodId.Push.CHAT_MESSAGE, buildChatPush(message));
            case ChatChannel.PRIVATE -> pushService.pushToPlayer(
                message.getTargetRoleId(), MethodId.Push.CHAT_MESSAGE, buildChatPush(message));
        }
        
        return Result.success();
    }
}
```

---

## 五、service-rank 排行服务

### 5.1 职责

- 排行榜数据管理
- 排名计算
- 排行榜快照

### 5.2 核心组件

| 组件 | 说明 |
|-----|------|
| RankBusinessService | 排行业务逻辑 |
| RankService | Redis 排行榜操作 |
| RankSnapshotRepository | 排行快照存储 |

### 5.3 示例：排行榜操作

```java
@Service
@RequiredArgsConstructor
public class RankBusinessService {
    
    private final RankService rankService;
    private final RankSnapshotRepository snapshotRepository;
    
    public void updateScore(RankType rankType, long roleId, long score) {
        String key = rankType.getKey();
        rankService.updateScore(key, roleId, score);
    }
    
    public List<RankEntry> getTopN(RankType rankType, int n) {
        String key = rankType.getKey();
        return rankService.getTopN(key, n);
    }
    
    public void createSnapshot(RankType rankType) {
        List<RankEntry> top100 = getTopN(rankType, 100);
        
        RankSnapshot snapshot = new RankSnapshot();
        snapshot.setRankType(rankType.name());
        snapshot.setEntries(top100);
        snapshot.setCreateTime(LocalDateTime.now());
        
        snapshotRepository.save(snapshot);
    }
}
```

---

## 六、service-scheduler 调度服务

### 6.1 职责

- 定时任务管理
- 跨服活动调度
- 数据清理任务

### 6.2 核心组件

| 组件 | 说明 |
|-----|------|
| DailyResetJob | 每日重置任务 |
| RankJob | 排行榜任务 |
| ActivityJob | 活动任务 |

### 6.3 示例：XXL-Job 任务

```java
@Component
@RequiredArgsConstructor
public class DailyResetJob {
    
    @DubboReference
    private PlayerService playerService;
    
    private final DistributedEventBus eventBus;
    
    @XxlJob("dailyResetHandler")
    public void dailyReset() {
        log.info("开始执行每日重置任务");
        
        // 1. 重置玩家每日数据
        playerService.resetDailyData();
        
        // 2. 广播每日重置事件
        eventBus.broadcast(new DailyResetEvent());
        
        log.info("每日重置任务完成");
    }
}

@Component
@RequiredArgsConstructor
public class RankJob {
    
    @DubboReference
    private RankSnapshotService rankSnapshotService;
    
    @XxlJob("rankSnapshotHandler")
    public void createRankSnapshot() {
        log.info("开始创建排行榜快照");
        
        for (RankType type : RankType.values()) {
            rankSnapshotService.createSnapshot(type);
        }
        
        log.info("排行榜快照创建完成");
    }
}
```

---

## 七、推荐的框架能力

### 各服务推荐使用的能力

| 服务 | 推荐能力 |
|-----|---------|
| service-game | ActorSystem, EventBus, CacheService, TimerService |
| service-guild | ActorSystem, SagaService, DubboPushService |
| service-chat | SecurityFilter, DubboPushService |
| service-rank | RankService (Redis ZSet), DistributedEventBus |
| service-scheduler | XXL-Job, DistributedEventBus |

---

**文档版本**: v1.0  
**最后更新**: 2026-01
