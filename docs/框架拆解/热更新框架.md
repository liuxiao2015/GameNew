# 热更新框架文档

本文档描述游戏服务器框架的热更新能力，包括 JSON 配置表热更新和 Groovy 代码热更新。

## 概述

框架提供两种热更新机制：

| 热更新类型 | 适用场景 | 技术方案 | 模块位置 |
|-----------|---------|---------|---------|
| JSON 配置热更新 | 数值表、配置表修改 | 文件监听 + HTTP 远程加载 | `framework-core` |
| Groovy 代码热更新 | 紧急 Bug 修复、临时逻辑修改 | Groovy 动态编译执行 | `support-gm` |

---

## 一、JSON 配置表热更新

### 1.1 核心组件

| 组件 | 功能 |
|-----|------|
| ConfigLoader | 配置加载器，支持热更新 |
| BaseConfigContainer | 配置容器基类 |
| ConfigVersion | 配置版本信息 |
| ConfigLoadResult | 配置加载结果 |
| ConfigReloadEvent | 配置重载事件（集群广播） |

### 1.2 功能特性

| 功能 | 说明 |
|-----|------|
| 本地加载 | 从 classpath 或文件系统加载 JSON 配置 |
| 远程加载 | 从 HTTP/HTTPS URL 加载配置（CDN/OSS） |
| 文件监听 | 自动检测配置文件变更并重载 |
| MD5 校验 | 避免重复加载相同内容 |
| 版本控制 | 记录配置版本历史 |
| 配置回滚 | 支持回滚到历史版本 |
| 预验证 | 加载前验证配置有效性 |
| 集群广播 | 通过事件总线同步到所有服务实例 |

### 1.3 配置项

```yaml
game:
  config:
    path: classpath:config/           # 配置文件路径
    remote-url: https://cdn.xxx/config # 远程配置URL（可选）
    watch: true                        # 启用文件监听
    max-backup: 5                      # 最大备份版本数
```

### 1.4 使用示例

#### 定义配置类

```java
@Data
public class ItemConfig implements GameConfig {
    private int id;
    private String name;
    private int type;
    private int maxStack;
    
    @Override
    public String validate() {
        if (maxStack <= 0) return "最大堆叠数必须大于0";
        return null;
    }
}
```

#### 定义配置容器

```java
@Component
@ConfigContainer(file = "item.json", configClass = ItemConfig.class)
public class ItemConfigContainer extends BaseConfigContainer<ItemConfig> {
    
    public List<ItemConfig> getByType(int type) {
        return findAll(c -> c.getType() == type);
    }
}
```

#### 热更新接口

```java
// 重载单个配置
configLoader.reload("item.json", "admin");

// 从远程重载
configLoader.reloadFromRemote("item.json", "admin");

// 重载并广播到集群
configLoader.reloadAndBroadcast("item.json", "admin");

// 回滚到指定版本
configLoader.rollback("item.json", 1705987654321L, "admin");
```

### 1.5 GM 接口

| 接口 | 方法 | 说明 |
|-----|-----|------|
| `/gm/config/list` | GET | 获取所有配置文件列表 |
| `/gm/config/status/{file}` | GET | 获取配置状态 |
| `/gm/config/reload/{file}` | POST | 热更新指定配置 |
| `/gm/config/reload/all` | POST | 热更新所有配置 |
| `/gm/config/rollback/{file}` | POST | 回滚配置 |
| `/gm/config/history/{file}` | GET | 获取版本历史 |

---

## 二、Groovy 代码热更新

### 2.1 核心组件

| 组件 | 功能 |
|-----|------|
| HotfixService | 热修复服务 |
| HotfixScript | 热修复脚本实体 |
| HotfixExecutionLog | 执行日志 |
| HotfixSyncEvent | 脚本同步事件（集群广播） |

### 2.2 功能特性

| 功能 | 说明 |
|-----|------|
| 脚本注册 | 注册 Groovy 脚本到 MongoDB |
| 脚本执行 | 执行已注册或一次性脚本 |
| 超时保护 | 脚本执行超时自动中断 |
| 执行日志 | 记录所有执行历史 |
| 版本管理 | 脚本版本自动递增 |
| 集群同步 | 脚本变更自动同步到所有实例 |
| Spring 集成 | 可访问所有 Spring Bean |

### 2.3 配置项

```yaml
game:
  hotfix:
    timeout-seconds: 30  # 脚本执行超时时间
```

### 2.4 脚本编写指南

#### 内置变量

| 变量 | 类型 | 说明 |
|-----|-----|------|
| `ctx` | ApplicationContext | Spring 容器 |
| `redis` | RedisService | Redis 操作 |
| `mongo` | MongoTemplate | MongoDB 操作 |
| `log` | Logger | 日志记录器 |
| `eventBus` | EventBus | 事件总线 |

#### 示例脚本

```groovy
// 获取 Spring Bean
def playerService = ctx.getBean("playerService")

// 查询数据
def player = mongo.findById(roleId, PlayerDocument.class)
log.info("查询到玩家: {}", player?.roleName)

// 修改数据
if (player != null) {
    player.gold += 10000
    mongo.save(player)
    log.info("给玩家 {} 增加 10000 金币", player.roleName)
}

// 返回结果
return [success: true, message: "修复完成", newGold: player?.gold]
```

### 2.5 GM 接口

| 接口 | 方法 | 说明 |
|-----|-----|------|
| `/gm/hotfix/list` | GET | 获取所有脚本列表 |
| `/gm/hotfix/{scriptId}` | GET | 获取脚本详情 |
| `/gm/hotfix/register` | POST | 注册/更新脚本 |
| `/gm/hotfix/execute/{scriptId}` | POST | 执行脚本 |
| `/gm/hotfix/execute-once` | POST | 执行一次性脚本 |
| `/gm/hotfix/{scriptId}` | DELETE | 删除脚本 |
| `/gm/hotfix/refresh` | POST | 刷新脚本缓存 |
| `/gm/hotfix/history/{scriptId}` | GET | 获取执行历史 |

---

## 三、安全建议

1. **权限控制** - 热更新接口需要严格的权限控制
2. **代码审查** - Groovy 脚本执行前需经过审查
3. **备份机制** - 配置热更新前自动备份
4. **监控告警** - 监控热更新执行情况

---

## 四、最佳实践

### 配置热更新

1. **开发环境**: 启用文件监听，实时生效
2. **测试环境**: 通过 GM 接口手动触发
3. **生产环境**: 结合 CI/CD，先更新 CDN 再触发热更新

### 代码热更新

1. **紧急修复**: 使用一次性脚本快速修复
2. **常用脚本**: 注册为持久化脚本便于复用
3. **复杂逻辑**: 先在测试环境验证

---

**文档版本**: v1.0  
**最后更新**: 2026-01
