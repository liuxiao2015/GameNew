# 广播与推送机制文档

本文档描述基于 Dubbo 的消息广播和推送机制。

---

## 概述

框架使用 Dubbo 作为主要的消息推送通道，替代传统的 Redis Pub/Sub，提供更可靠、更高效的消息传递。

### 核心组件

| 组件 | 位置 | 功能 |
|-----|------|------|
| DubboPushService | framework-core | 业务层推送入口 |
| PushTargetService | common-api | 推送服务接口 |
| PushTargetServiceImpl | gateway-server | Gateway 层推送实现 |
| BroadcastService | common-api | 服务间广播接口 |
| BroadcastServiceAdapter | framework-core | 广播消息适配器 |

---

## 一、客户端推送

### 1.1 推送类型矩阵

| 推送类型 | 方法 | Dubbo 模式 | 说明 |
|---------|------|------------|------|
| 单播 | `pushToPlayer(roleId, ...)` | consistenthash | 按 roleId 路由 |
| 多播 | `pushToPlayers(roleIds, ...)` | broadcast | 各 Gateway 筛选 |
| 公会广播 | `pushToGuild(guildId, ...)` | broadcast | 按 guildId 筛选 |
| 全服广播 | `broadcast(...)` | broadcast | 全服在线玩家 |
| 区服广播 | `broadcastToServer(serverId, ...)` | broadcast | 指定区服 |
| 等级筛选 | `broadcastToLevel(min, max, ...)` | broadcast | 等级范围 |
| VIP筛选 | `broadcastToVip(min, max, ...)` | broadcast | VIP等级范围 |
| 场景推送 | `pushToScene(sceneId, ...)` | broadcast | 场景内玩家 |
| 房间推送 | `pushToRoom(roomId, ...)` | broadcast | 房间内玩家 |
| AOI推送 | `pushToNearby(sceneId, x, y, r, ...)` | broadcast | 附近玩家 |

### 1.2 使用示例

```java
@Autowired
private DubboPushService pushService;

// 单播 - 发送给指定玩家
pushService.pushToPlayer(roleId, MethodId.Push.MAIL_NEW, newMailMessage);

// 公会广播 - 发送给公会所有成员
pushService.pushToGuild(guildId, MethodId.Push.GUILD_NOTICE, noticeMessage);

// 公会广播（排除发送者）
pushService.pushToGuildExclude(guildId, senderRoleId, MethodId.Push.GUILD_CHAT, chatMessage);

// 全服广播 - 发送给所有在线玩家
pushService.broadcast(MethodId.Push.SYSTEM_NOTICE, systemNotice);

// 区服广播 - 发送给指定区服
pushService.broadcastToServer(serverId, MethodId.Push.SERVER_EVENT, eventMessage);

// VIP 专属推送
pushService.broadcastToVip(3, 0, MethodId.Push.VIP_GIFT, vipGiftMessage);

// 场景同步 - 战斗同步
pushService.pushToScene(sceneId, MethodId.Push.BATTLE_SYNC, battleSyncMessage);

// AOI 推送 - 附近玩家
pushService.pushToNearby(sceneId, x, y, 100, MethodId.Push.PLAYER_MOVE, moveMessage);
```

### 1.3 Session 属性

为支持高效的消息筛选，Session 存储了以下属性：

| 属性 | 类型 | 说明 | 更新时机 |
|-----|------|------|---------|
| level | int | 玩家等级 | 升级时 |
| vipLevel | int | VIP等级 | VIP变更时 |
| guildId | long | 公会ID | 加入/退出公会时 |
| sceneId | long | 场景ID | 切换场景时 |
| roomId | long | 房间ID | 进入/退出房间时 |
| x, y | int | 坐标 | 移动时 |

---

## 二、服务间广播

### 2.1 广播类型

| 类型 | 方法 | 说明 |
|-----|------|------|
| 配置刷新 | `broadcastConfigReload(name, operator)` | 通知所有服务刷新配置 |
| 缓存失效 | `broadcastCacheEvict(cache, key)` | 通知所有服务清除缓存 |
| 自定义消息 | `broadcastCustomMessage(type, data)` | 自定义广播消息 |

### 2.2 使用示例

```java
@Autowired
private BroadcastService broadcastService;

// 配置刷新广播
broadcastService.broadcastConfigReload("item.json", "admin");

// 缓存失效广播
broadcastService.broadcastCacheEvict("player", String.valueOf(roleId));

// 自定义消息广播
broadcastService.broadcastCustomMessage("activity_start", activityJson);
```

### 2.3 接收广播

```java
@Component
public class BroadcastListener {
    
    @EventListener
    public void onConfigReload(ConfigReloadEvent event) {
        log.info("配置刷新: {}", event.getConfigName());
        // 处理配置刷新
    }
    
    @EventListener
    public void onCacheEvict(CacheEvictEvent event) {
        log.info("缓存失效: {}:{}", event.getCacheName(), event.getKey());
        // 清除本地缓存
    }
}
```

---

## 三、架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     业务服务层                               │
│   GameService    GuildService    ChatService   RankService  │
│        │              │               │             │       │
│        └──────────────┴───────────────┴─────────────┘       │
│                         │                                   │
│                  DubboPushService                           │
│                         │                                   │
└─────────────────────────┼───────────────────────────────────┘
                          │
              ┌───────────┴───────────┐
              │     Dubbo RPC         │
              │  (broadcast 模式)      │
              └───────────┬───────────┘
                          │
         ┌────────────────┼────────────────┐
    ┌────▼────┐      ┌────▼────┐      ┌────▼────┐
    │Gateway 1│      │Gateway 2│      │Gateway 3│
    │(Sessions)│     │(Sessions)│     │(Sessions)│
    └────┬────┘      └────┬────┘      └────┬────┘
         │                │                │
    ┌────▼────┐      ┌────▼────┐      ┌────▼────┐
    │ 客户端   │      │ 客户端   │      │ 客户端   │
    └─────────┘      └─────────┘      └─────────┘
```

---

## 四、最佳实践

### 4.1 选择正确的推送方式

| 场景 | 推荐方式 |
|-----|---------|
| 发送给单个玩家 | pushToPlayer（一致性哈希） |
| 发送给多个玩家 | pushToPlayers（广播筛选） |
| 公会内消息 | pushToGuild |
| 系统公告 | broadcast |
| 战斗同步 | pushToScene |
| AOI同步 | pushToNearby |

### 4.2 性能优化

1. **尽量使用单播** - 单播使用一致性哈希，只发送到一个 Gateway
2. **减少广播频率** - 广播会发送到所有 Gateway，频率过高会增加网络开销
3. **合并小消息** - 多个小消息可以合并成一个批量消息

### 4.3 Session 属性更新

```java
// 玩家升级时更新 Session
session.setLevel(newLevel);

// 加入公会时更新 Session
session.setGuildId(guildId);

// 进入场景时更新 Session
session.setSceneId(sceneId);
session.setX(x);
session.setY(y);
```

---

**文档版本**: v1.0  
**最后更新**: 2026-01
