# 完整登录流程

本文档描述从客户端连接到进入游戏的完整流程。

---

## 流程概览

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  客户端   │────▶│  Gateway │────▶│  Login   │────▶│   Game   │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
     │                │                │                │
     │ 1.连接+握手     │                │                │
     │◀──────────────▶│                │                │
     │                │                │                │
     │ 2.账号登录      │ Dubbo RPC      │                │
     │───────────────▶│───────────────▶│                │
     │◀───────────────│◀───────────────│                │
     │                │                │                │
     │ 3.获取服务器列表 │                │                │
     │───────────────▶│───────────────▶│                │
     │◀───────────────│◀───────────────│                │
     │                │                │                │
     │ 4.选择服务器    │                │                │
     │───────────────▶│───────────────▶│                │
     │◀───────────────│◀───────────────│                │
     │                │                │                │
     │ 5.获取角色列表  │                │                │
     │───────────────▶│───────────────▶│                │
     │◀───────────────│◀───────────────│                │
     │                │                │                │
     │ 6.创建角色(可选)│                │                │
     │───────────────▶│───────────────▶│                │
     │◀───────────────│◀───────────────│                │
     │                │                │                │
     │ 7.进入游戏      │                │ Dubbo RPC      │
     │───────────────▶│───────────────▶│───────────────▶│
     │◀───────────────│◀───────────────│◀───────────────│
     │                │                │                │
```

---

## 一、连接与握手

### 1.1 客户端发起连接

```
WebSocket: ws://gateway-host:8080/ws
TCP: gateway-host:8888
```

### 1.2 握手请求

```protobuf
message C2S_Handshake {
    string client_version = 1;  // 客户端版本
    string device_id = 2;       // 设备ID
    string platform = 3;        // 平台 (ios/android/web)
    string channel = 4;         // 渠道
}
```

### 1.3 握手响应

```protobuf
message S2C_Handshake {
    Result result = 1;
    int64 server_time = 2;      // 服务器时间
    string session_id = 3;      // 会话ID
    bool need_update = 4;       // 是否需要更新
    string update_url = 5;      // 更新地址
}
```

### 1.4 Gateway 处理

```java
@Protocol(methodId = MethodId.System.HANDSHAKE, desc = "握手", 
          requireLogin = false, requireRole = false)
public Message handshake(Session session, C2S_Handshake request) {
    // 1. 检查版本
    if (needUpdate(request.getClientVersion())) {
        return S2C_Handshake.newBuilder()
            .setResult(buildSuccessResult())
            .setNeedUpdate(true)
            .setUpdateUrl(getUpdateUrl())
            .build();
    }
    
    // 2. 生成会话ID
    String sessionId = generateSessionId();
    session.setSessionId(sessionId);
    
    return S2C_Handshake.newBuilder()
        .setResult(buildSuccessResult())
        .setServerTime(System.currentTimeMillis())
        .setSessionId(sessionId)
        .build();
}
```

---

## 二、账号登录

### 2.1 登录请求

```protobuf
message C2S_AccountLogin {
    string login_type = 1;      // 登录类型: guest/account/google/facebook
    string credential = 2;      // 凭证 (token/密码/第三方token)
    string account = 3;         // 账号 (可选)
}
```

### 2.2 登录响应

```protobuf
message S2C_AccountLogin {
    Result result = 1;
    int64 account_id = 2;       // 账号ID
    string token = 3;           // 登录token
    int64 token_expire = 4;     // token过期时间
    bool is_new = 5;            // 是否新注册
}
```

### 2.3 Login 服务处理

```java
@Protocol(methodId = MethodId.Login.ACCOUNT_LOGIN, desc = "账号登录",
          requireLogin = false, requireRole = false)
public Message accountLogin(Session session, C2S_AccountLogin request) {
    // 1. 验证凭证
    AccountData account = switch (request.getLoginType()) {
        case "guest" -> loginAsGuest(request.getCredential());
        case "account" -> loginWithPassword(request.getAccount(), request.getCredential());
        case "google" -> loginWithGoogle(request.getCredential());
        case "facebook" -> loginWithFacebook(request.getCredential());
        default -> throw new BizException(ErrorCode.PARAM_ERROR);
    };
    
    // 2. 生成 token
    String token = tokenService.generateToken(account.getAccountId());
    
    // 3. 更新 session
    session.setAccountId(account.getAccountId());
    session.setToken(token);
    session.setAuthenticated(true);
    
    return S2C_AccountLogin.newBuilder()
        .setResult(buildSuccessResult())
        .setAccountId(account.getAccountId())
        .setToken(token)
        .setTokenExpire(tokenService.getExpireTime(token))
        .setIsNew(account.isNew())
        .build();
}
```

---

## 三、获取服务器列表

### 3.1 请求/响应

```protobuf
message C2S_GetServerList {}

message S2C_GetServerList {
    Result result = 1;
    repeated ServerInfo servers = 2;
    int32 last_server_id = 3;   // 上次登录的服务器
}

message ServerInfo {
    int32 server_id = 1;
    string server_name = 2;
    int32 status = 3;           // 0:维护 1:正常 2:繁忙 3:火爆
    bool is_new = 4;            // 是否新服
    bool is_recommend = 5;      // 是否推荐
}
```

---

## 四、选择服务器

### 4.1 请求/响应

```protobuf
message C2S_SelectServer {
    int32 server_id = 1;
}

message S2C_SelectServer {
    Result result = 1;
    string game_token = 2;      // 游戏服务器token
    string game_host = 3;       // 游戏服务器地址 (如需切换)
    int32 game_port = 4;
}
```

---

## 五、获取角色列表

### 5.1 请求/响应

```protobuf
message C2S_GetRoleList {}

message S2C_GetRoleList {
    Result result = 1;
    repeated RoleBrief roles = 2;
    int32 max_role_count = 3;   // 最大角色数
}

message RoleBrief {
    int64 role_id = 1;
    string role_name = 2;
    int32 level = 3;
    int32 profession = 4;       // 职业
    int64 last_login_time = 5;
}
```

---

## 六、创建角色

### 6.1 请求/响应

```protobuf
message C2S_CreateRole {
    string role_name = 1;
    int32 profession = 2;
    int32 gender = 3;
}

message S2C_CreateRole {
    Result result = 1;
    RoleBrief role = 2;
}
```

### 6.2 处理逻辑

```java
@Protocol(methodId = MethodId.Login.CREATE_ROLE, desc = "创建角色")
public Message createRole(Session session, C2S_CreateRole request) {
    // 1. 检查角色数量
    int count = roleRepository.countByAccountId(session.getAccountId());
    if (count >= MAX_ROLE_COUNT) {
        throw new BizException(ErrorCode.ROLE_COUNT_LIMIT);
    }
    
    // 2. 检查名称
    if (!securityFilter.validateNickname(request.getRoleName())) {
        throw new BizException(ErrorCode.INVALID_NICKNAME);
    }
    
    // 3. 创建角色
    long roleId = idService.nextPlayerId();
    RoleData role = new RoleData();
    role.setRoleId(roleId);
    role.setRoleName(request.getRoleName());
    role.setProfession(request.getProfession());
    role.setAccountId(session.getAccountId());
    role.setServerId(session.getServerId());
    role.setLevel(1);
    role.setCreateTime(LocalDateTime.now());
    
    roleRepository.save(role);
    
    return S2C_CreateRole.newBuilder()
        .setResult(buildSuccessResult())
        .setRole(buildRoleBrief(role))
        .build();
}
```

---

## 七、进入游戏

### 7.1 请求/响应

```protobuf
message C2S_EnterGame {
    int64 role_id = 1;
}

message S2C_EnterGame {
    Result result = 1;
    PlayerInfo player = 2;      // 完整玩家信息
    int64 server_time = 3;
    string reconnect_token = 4; // 断线重连token
}
```

### 7.2 处理逻辑

```java
@Protocol(methodId = MethodId.Login.ENTER_GAME, desc = "进入游戏")
public Message enterGame(Session session, C2S_EnterGame request) {
    // 1. 验证角色归属
    RoleData role = roleRepository.findById(request.getRoleId());
    if (role == null || role.getAccountId() != session.getAccountId()) {
        throw new BizException(ErrorCode.ROLE_NOT_FOUND);
    }
    
    // 2. 检查是否封禁
    if (role.isBanned()) {
        throw new BizException(ErrorCode.ROLE_BANNED);
    }
    
    // 3. 更新 session
    session.setRoleId(role.getRoleId());
    session.setRoleName(role.getRoleName());
    session.setLevel(role.getLevel());
    
    // 4. 调用 Game 服务加载玩家
    PlayerInfo playerInfo = gameService.enterGame(role.getRoleId());
    
    // 5. 生成重连 token
    String reconnectToken = session.getReconnectToken();
    
    // 6. 发布上线事件
    eventBus.publish(new PlayerOnlineEvent(role.getRoleId(), session.getServerId()));
    
    return S2C_EnterGame.newBuilder()
        .setResult(buildSuccessResult())
        .setPlayer(playerInfo)
        .setServerTime(System.currentTimeMillis())
        .setReconnectToken(reconnectToken)
        .build();
}
```

---

## 八、断线重连

### 8.1 重连请求

```protobuf
message C2S_Reconnect {
    string reconnect_token = 1;
}

message S2C_Reconnect {
    Result result = 1;
    bool success = 2;
    PlayerInfo player = 3;      // 重连成功时返回
}
```

### 8.2 处理逻辑

```java
@Protocol(methodId = MethodId.System.RECONNECT, desc = "断线重连",
          requireLogin = false, requireRole = false)
public Message reconnect(Session session, C2S_Reconnect request) {
    // 1. 查找旧会话
    Session oldSession = sessionManager.findByReconnectToken(request.getReconnectToken());
    if (oldSession == null || oldSession.isReconnectTimeout()) {
        return S2C_Reconnect.newBuilder()
            .setResult(buildSuccessResult())
            .setSuccess(false)
            .build();
    }
    
    // 2. 恢复会话数据
    session.copyFrom(oldSession);
    session.reconnect(session.getChannel());
    
    // 3. 获取玩家信息
    PlayerInfo playerInfo = gameService.getPlayerInfo(session.getRoleId());
    
    return S2C_Reconnect.newBuilder()
        .setResult(buildSuccessResult())
        .setSuccess(true)
        .setPlayer(playerInfo)
        .build();
}
```

---

## 九、登录类型支持

| 登录类型 | 说明 | 凭证内容 |
|---------|------|---------|
| guest | 游客登录 | 设备ID |
| account | 账号密码 | MD5(密码) |
| google | Google登录 | OAuth token |
| facebook | Facebook登录 | Access token |
| apple | Apple登录 | Identity token |
| token | Token登录 | 之前的登录token |

---

**文档版本**: v1.0  
**最后更新**: 2026-01
